# 第9章：内存模型与生命周期

## UObject 的内存管理

```
┌─────────────────────────────────────────────────────────────┐
│                    UObject 内存管理                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   C++ 层                        AS 层                       │
│   ┌─────────┐                   ┌─────────┐                │
│   │ UObject │◄──────────────────│ UObject │                │
│   │  实例   │    指针传递       │   句柄  │                │
│   └────┬────┘                   └─────────┘                │
│        │                                                    │
│        │ GC 管理                                            │
│        ▼                                                    │
│   ┌──────────────────────────────────────────────────────┐ │
│   │               UE 垃圾回收器 (GC)                      │ │
│   │  - 标记-清除算法                                      │ │
│   │  - 自动追踪 UPROPERTY 引用                           │ │
│   │  - 定期清理无引用对象                                │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
│   AS 端不参与引用计数（asOBJ_NOCOUNT）                      │
│   UObject 的生命周期完全由 UE 管理                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## UScriptStruct 的内存管理

```
┌─────────────────────────────────────────────────────────────┐
│                 UScriptStruct 内存管理                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   AS 代码                           内存布局                 │
│   ┌─────────────────┐               ┌─────────────────┐    │
│   │ void MyFunc()   │               │   AS 栈帧       │    │
│   │ {               │               │ ┌─────────────┐ │    │
│   │   FVector v;    │ ─────────────►│ │ FVector v   │ │    │
│   │   v.X = 1.0;    │               │ │ X: 1.0      │ │    │
│   │ }               │               │ │ Y: 0.0      │ │    │
│   └─────────────────┘               │ │ Z: 0.0      │ │    │
│                                     │ └─────────────┘ │    │
│   函数退出时自动调用析构函数         │   ▲ 自动销毁   │    │
│                                     └───┼─────────────┘    │
│                                         │                   │
│   值语义：赋值 = 复制                    │                   │
│   FVector v2 = v; ──► 创建新的 FVector   │                   │
│                       独立内存           │                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## asOBJ 标志详解

| 标志 | 值 | 说明 |
|------|-----|------|
| `asOBJ_REF` | 0x01 | 引用类型（堆分配） |
| `asOBJ_VALUE` | 0x02 | 值类型（栈分配） |
| `asOBJ_GC` | 0x04 | 参与 AS 垃圾回收 |
| `asOBJ_POD` | 0x08 | 简单数据类型（可 memcpy） |
| `asOBJ_NOCOUNT` | 0x10 | 不使用 AS 引用计数 |
| `asOBJ_APP_CLASS` | 0x100 | C++ 定义的类 |
| `asOBJ_IMPLICIT_HANDLE` | 0x400 | 隐式句柄（省略 @） |
| `asOBJ_TEMPLATE` | 0x800 | 模板类型 |

## 常见内存问题

### 1. 悬空引用

```angelscript
// 危险：Actor 可能被 GC 销毁
AActor MyActor = GetSomeActor();
// ... 一段时间后 ...
MyActor.DoSomething();  // 可能崩溃！

// 安全做法：使用前检查
if (IsValid(MyActor))
{
    MyActor.DoSomething();
}
```

### 2. 值类型的深拷贝

```angelscript
// FVector 是值类型，赋值会复制
FVector A = FVector(1, 2, 3);
FVector B = A;  // B 是 A 的副本
B.X = 100;      // 不影响 A

// 但如果 FVector 内部有指针成员（假设），
// 需要确保绑定了正确的拷贝构造函数
```

### 3. 临时值的生命周期

```angelscript
// 危险：临时值在表达式结束后销毁
const FVector& Ref = GetVector();  // GetVector 返回临时值
Print(Ref.X);  // 可能是未定义行为

// 安全做法：复制
FVector Value = GetVector();
Print(Value.X);
```

---

**上一章**: [08_泛型模板绑定.md](./08_泛型模板绑定.md)  
**下一章**: [10_实战案例.md](./10_实战案例.md) - 实际项目中的绑定案例