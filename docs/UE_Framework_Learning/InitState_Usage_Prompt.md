# 初始化状态机使用指南（AI 提示文档）

> **用途**：在与 AI 讨论 UE 组件初始化、异步依赖等问题时，用于提示 AI 参考本项目的初始化状态机模式。

---

## ⚠️ 重要提示

**在建议使用此机制前，AI 必须先评估是否真的需要！**

不是所有初始化问题都需要状态机。请先判断问题的复杂度。

---

## 机制核心概念

本项目使用 `IGameFrameworkInitStateInterface` 实现组件初始化管理：

| 概念 | 说明 |
|-----|------|
| 状态链 | 用 `FGameplayTag` 定义有序状态序列 |
| 条件判断 | `CanChangeInitState` 检查能否转换 |
| 事件驱动 | 不轮询，靠事件触发 `CheckDefaultInitialization` |
| 弱引用委托 | `CreateWeakLambda` 保证生命周期安全 |
| 协调者 | `PawnExtensionComponent` 统一协调各功能组件 |

**详细文档参考**：[InitState_Binding_Mechanism.md](./InitState_Binding_Mechanism.md)

---

## ✅ 适用场景（应该使用）

满足以下 **2 个或以上** 条件时，考虑使用：

- [ ] 存在 **多个组件** 之间的初始化依赖
- [ ] 需要等待 **网络复制**（`OnRep_XXX`）完成
- [ ] 初始化条件可能 **异步满足**（数据延迟到达）
- [ ] 需要 **解耦** 组件间的直接引用
- [ ] 是 **可扩展的模块化功能**（如 GameFeature 组件）
- [ ] 存在 **明确的状态阶段**（生成→就绪→激活）

### 典型案例

```
✓ 角色能力系统初始化（等待 PawnData）
✓ 多人游戏客户端等待服务器数据
✓ 多个系统组件协调启动
✓ 插件/模组动态注入初始化流程
```

---

## ❌ 不适用场景（不应该使用）

满足以下 **任一** 条件时，**不要使用**：

- [ ] 只是 **单个组件** 的简单初始化
- [ ] 初始化 **同步完成**，无需等待
- [ ] 只需要简单的 **BeginPlay 顺序**
- [ ] 问题可以用 **简单委托/事件** 解决
- [ ] 是 **一次性** 的简单逻辑，不需要状态追踪

### 典型案例

```
✗ 单个组件读取配置文件
✗ BeginPlay 里直接能获取到的数据
✗ 简单的父子组件通信
✗ 不涉及网络的单机逻辑
```

---

## 🤔 决策流程图

```
需要初始化某个功能
        │
        ▼
┌───────────────────┐
│ 是否涉及多个组件？ │
└───────────────────┘
        │
   是   │   否
        │    └──→ 简单 BeginPlay 即可
        ▼
┌───────────────────┐
│ 是否有异步依赖？   │
│ (网络/延迟数据)    │
└───────────────────┘
        │
   是   │   否
        │    └──→ 考虑简单委托通知
        ▼
┌───────────────────┐
│ 是否需要解耦？     │
│ (组件不应直接引用) │
└───────────────────┘
        │
   是   │   否
        │    └──→ 直接组件引用 + 委托
        ▼
  使用初始化状态机 ✓
```

---

## 快速判断清单

**回答以下问题，如果 "是" ≥ 3 个，考虑使用状态机：**

1. 初始化失败后需要重试吗？
2. 有多个组件需要互相等待吗？
3. 涉及网络复制吗？
4. 未来可能添加更多依赖组件吗？
5. 需要追踪"初始化到哪一步了"吗？

---

## 给 AI 的提醒

### 在用户建议使用此机制时

1. **先评估复杂度**：问题是否真的需要状态机？
2. **考虑简单方案**：能用 BeginPlay + 委托解决吗？
3. **权衡成本**：引入状态机的代码复杂度是否值得？

### 应该质疑用户的情况

- 用户描述的场景很简单，但坚持用状态机
- 只有单个组件，没有依赖关系
- 所有数据在 BeginPlay 时已经可用

### 应该支持用户的情况

- 场景确实涉及多组件异步协调
- 现有简单方案已经出现问题（时序 bug、空指针）
- 需要为未来扩展预留空间

---

## 实现参考

如果确定使用，参考以下文件：

| 文件 | 作用 |
|-----|------|
| `DJ01PawnExtensionComponent` | 协调者示例 |
| `DJ01HeroComponent` | 依赖者示例 |
| `DJ01GameplayTags.h` | 状态 Tag 定义 |

---

*文档版本: v1.0 | 创建日期: 2024-12-02*