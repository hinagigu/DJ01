# 07. åŠ¨ç”»å±‚åˆ‡æ¢

> **é¢„è®¡è€—æ—¶**: 30 åˆ†é’Ÿ  
> **å‰ç½®æ¡ä»¶**: å·²å®Œæˆ 06_BindingSeté›†æˆ

---

## ğŸ¯ æœ¬ç« ç›®æ ‡

å®ç°è¿è¡Œæ—¶åŠ¨ç”»å±‚åˆ‡æ¢ï¼š

1. âœ… ä½¿ç”¨ `LinkAnimClassLayers` åˆ‡æ¢æ­¦å™¨åŠ¨ç”»
2. âœ… åœ¨è§’è‰²/æŠ€èƒ½ä¸­è°ƒç”¨åˆ‡æ¢é€»è¾‘
3. âœ… å¤„ç†åˆ‡æ¢æ—¶çš„å¹³æ»‘è¿‡æ¸¡

---

## ğŸ“š LinkAnimClassLayers åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è§’è‰² Mesh çš„åŠ¨ç”»å®ä¾‹                         â”‚
â”‚                 (ABP_DJ01Character_Base)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Linked Layers: [ç©º]                                        â”‚
â”‚                                                              â”‚
â”‚  è°ƒç”¨ LinkAnimClassLayers(ABP_AnimLayer_Katana)             â”‚
â”‚                    â”‚                                         â”‚
â”‚                    â–¼                                         â”‚
â”‚  Linked Layers: [ABP_AnimLayer_Katana]  â† åˆ€åŠ¨ç”»æ¿€æ´»        â”‚
â”‚                                                              â”‚
â”‚  è°ƒç”¨ LinkAnimClassLayers(ABP_AnimLayer_SwordShield)        â”‚
â”‚                    â”‚                                         â”‚
â”‚                    â–¼                                         â”‚
â”‚  Linked Layers: [ABP_AnimLayer_SwordShield]  â† è‡ªåŠ¨æ›¿æ¢     â”‚
â”‚                                                              â”‚
â”‚  è°ƒç”¨ UnlinkAnimClassLayers(å½“å‰å±‚)                         â”‚
â”‚                    â”‚                                         â”‚
â”‚                    â–¼                                         â”‚
â”‚  Linked Layers: [ç©º]  â† æ¢å¤é»˜è®¤                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–¹æ³• 1: åœ¨è§’è‰²è“å›¾ä¸­åˆ‡æ¢

### Step 1: åˆ›å»ºåˆ‡æ¢å‡½æ•°

åœ¨è§’è‰²è“å›¾ (å¦‚ `BP_DJ01Character`) ä¸­ï¼š

1. **åˆ›å»ºå‡½æ•°**: `SwitchWeaponAnimLayer`

2. **æ·»åŠ è¾“å…¥å‚æ•°**:
   - `NewLayerClass`: `Class Reference (AnimInstance)`

3. **å®ç°**:

```
[è¾“å…¥: NewLayerClass]
         â”‚
         â–¼
[Get Mesh] â”€â”€â†’ [Get Anim Instance]
                     â”‚
                     â–¼
              [Link Anim Class Layers]
                     â”‚
                     â”‚ In Class: NewLayerClass
                     â–¼
              [å®Œæˆ]
```

**è¯¦ç»†è“å›¾èŠ‚ç‚¹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Function: SwitchWeaponAnimLayer                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [Input: NewLayerClass (Class<AnimInstance>)]               â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  [Get Mesh]                                                  â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  [Get Anim Instance]                                         â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  [Is Valid?] â”€â”€â†’ [Branch]                                   â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â”œâ”€â”€ True â”€â”€â†’ [Link Anim Class Layers]  â”‚
â”‚                      â”‚                â”‚                      â”‚
â”‚                      â”‚                â”‚ In Class            â”‚
â”‚                      â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â””â”€â”€ False â”€â”€â†’ [Print: "No Anim Inst"]  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 2: è°ƒç”¨åˆ‡æ¢

åœ¨è£…å¤‡æ­¦å™¨æ—¶è°ƒç”¨ï¼š

```
[Event: OnWeaponEquipped (WeaponType)]
         â”‚
         â”œâ”€â”€ Katana â”€â”€â†’ [Switch: ABP_AnimLayer_Katana]
         â”‚
         â”œâ”€â”€ SwordShield â”€â”€â†’ [Switch: ABP_AnimLayer_SwordShield]
         â”‚
         â””â”€â”€ Unarmed â”€â”€â†’ [Switch: ABP_AnimLayer_Unarmed]
```

---

## ğŸ“ æ–¹æ³• 2: åœ¨ C++ ä¸­åˆ‡æ¢ (æ¨è)

åœ¨è§’è‰²ç±»ä¸­æ·»åŠ ï¼š

```cpp
// DJ01Character.h

UCLASS()
class ADJ01Character : public ACharacter
{
    GENERATED_BODY()
    
public:
    /** åˆ‡æ¢æ­¦å™¨åŠ¨ç”»å±‚ */
    UFUNCTION(BlueprintCallable, Category = "Animation")
    void SwitchWeaponAnimLayer(TSubclassOf<UAnimInstance> NewLayerClass);
    
    /** æ¸…é™¤å½“å‰åŠ¨ç”»å±‚ï¼Œæ¢å¤é»˜è®¤ */
    UFUNCTION(BlueprintCallable, Category = "Animation")
    void ClearWeaponAnimLayer();

protected:
    /** å½“å‰æ¿€æ´»çš„åŠ¨ç”»å±‚ç±» */
    UPROPERTY()
    TSubclassOf<UAnimInstance> CurrentAnimLayerClass;
};
```

```cpp
// DJ01Character.cpp

void ADJ01Character::SwitchWeaponAnimLayer(TSubclassOf<UAnimInstance> NewLayerClass)
{
    if (!NewLayerClass)
    {
        return;
    }
    
    USkeletalMeshComponent* MeshComp = GetMesh();
    if (!MeshComp)
    {
        return;
    }
    
    UAnimInstance* AnimInstance = MeshComp->GetAnimInstance();
    if (!AnimInstance)
    {
        return;
    }
    
    // å¦‚æœå·²ç»æ˜¯è¿™ä¸ªå±‚ï¼Œä¸éœ€è¦åˆ‡æ¢
    if (CurrentAnimLayerClass == NewLayerClass)
    {
        return;
    }
    
    // åˆ‡æ¢åŠ¨ç”»å±‚
    AnimInstance->LinkAnimClassLayers(NewLayerClass);
    CurrentAnimLayerClass = NewLayerClass;
    
    UE_LOG(LogTemp, Log, TEXT("Switched anim layer to: %s"), *NewLayerClass->GetName());
}

void ADJ01Character::ClearWeaponAnimLayer()
{
    if (!CurrentAnimLayerClass)
    {
        return;
    }
    
    USkeletalMeshComponent* MeshComp = GetMesh();
    if (UAnimInstance* AnimInstance = MeshComp ? MeshComp->GetAnimInstance() : nullptr)
    {
        AnimInstance->UnlinkAnimClassLayers(CurrentAnimLayerClass);
        CurrentAnimLayerClass = nullptr;
    }
}
```

---

## ğŸ“ æ–¹æ³• 3: åœ¨ AngelScript æŠ€èƒ½ä¸­åˆ‡æ¢

```angelscript
// GA_EquipWeapon.as

class UGA_EquipWeapon : UDJ01GameplayAbility
{
    UPROPERTY(EditDefaultsOnly, Category = "Weapon")
    TSubclassOf<UAnimInstance> WeaponAnimLayerClass;
    
    UFUNCTION(BlueprintOverride)
    void ActivateAbility()
    {
        // è·å–è§’è‰²
        AActor OwnerActor = GetAvatarActorFromActorInfo();
        ADJ01Character Character = Cast<ADJ01Character>(OwnerActor);
        
        if (IsValid(Character) && IsValid(WeaponAnimLayerClass))
        {
            // åˆ‡æ¢åŠ¨ç”»å±‚
            Character.SwitchWeaponAnimLayer(WeaponAnimLayerClass);
        }
        
        EndAbility();
    }
}
```

---

## ğŸ”§ ä¸æ­¦å™¨ç³»ç»Ÿé›†æˆ

### æ­¦å™¨æ•°æ®èµ„äº§

åˆ›å»ºæ­¦å™¨æ•°æ®èµ„äº§ï¼ŒåŒ…å«åŠ¨ç”»å±‚å¼•ç”¨ï¼š

```cpp
// WeaponData.h

UCLASS(BlueprintType)
class UWeaponData : public UPrimaryDataAsset
{
    GENERATED_BODY()
    
public:
    /** æ­¦å™¨åç§° */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    FText WeaponName;
    
    /** æ­¦å™¨ç½‘æ ¼ */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    UStaticMesh* WeaponMesh;
    
    /** å¯¹åº”çš„åŠ¨ç”»å±‚ */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    TSubclassOf<UAnimInstance> AnimLayerClass;
    
    /** è¿æ‹›å›¾ */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    UComboGraph* ComboGraph;
};
```

### è£…å¤‡æ­¦å™¨æ—¶è‡ªåŠ¨åˆ‡æ¢

```cpp
void ADJ01Character::EquipWeapon(UWeaponData* WeaponData)
{
    if (!WeaponData)
    {
        return;
    }
    
    // ç”Ÿæˆæ­¦å™¨ç½‘æ ¼
    // ...
    
    // åˆ‡æ¢åŠ¨ç”»å±‚
    if (WeaponData->AnimLayerClass)
    {
        SwitchWeaponAnimLayer(WeaponData->AnimLayerClass);
    }
    
    // è®¾ç½®è¿æ‹›å›¾
    CurrentComboGraph = WeaponData->ComboGraph;
}
```

---

## ğŸ¨ å¹³æ»‘è¿‡æ¸¡å¤„ç†

`LinkAnimClassLayers` é»˜è®¤ä¼šç«‹å³åˆ‡æ¢ï¼Œå¯èƒ½å¯¼è‡´åŠ¨ç”»è·³å˜ã€‚å¤„ç†æ–¹æ³•ï¼š

### æ–¹æ³• 1: ä½¿ç”¨ Blend Settings

åœ¨ `LinkAnimClassLayers` åæ·»åŠ æ··åˆï¼š

```cpp
void ADJ01Character::SwitchWeaponAnimLayerWithBlend(
    TSubclassOf<UAnimInstance> NewLayerClass, 
    float BlendTime)
{
    // ... éªŒè¯ä»£ç  ...
    
    // ä¿å­˜å½“å‰åŠ¨ç”»å§¿åŠ¿
    // (UE5 è‡ªåŠ¨å¤„ç†ï¼Œä¸éœ€è¦é¢å¤–ä»£ç )
    
    // åˆ‡æ¢å±‚
    AnimInstance->LinkAnimClassLayers(NewLayerClass);
    
    // æ··åˆç”±åŠ¨ç”»è“å›¾çš„çŠ¶æ€è½¬æ¢è®¾ç½®æ§åˆ¶
}
```

### æ–¹æ³• 2: ä½¿ç”¨è¿‡æ¸¡è’™å¤ªå¥‡

åœ¨åˆ‡æ¢æ—¶æ’­æ”¾è¿‡æ¸¡åŠ¨ç”»ï¼š

```cpp
void ADJ01Character::SwitchWeaponWithTransition(
    UWeaponData* NewWeapon,
    UAnimMontage* TransitionMontage)
{
    // æ’­æ”¾è¿‡æ¸¡è’™å¤ªå¥‡
    if (TransitionMontage)
    {
        PlayAnimMontage(TransitionMontage);
        
        // åœ¨è’™å¤ªå¥‡ä¸­é—´ç‚¹åˆ‡æ¢åŠ¨ç”»å±‚
        // ä½¿ç”¨ AnimNotify è§¦å‘
    }
    
    // åˆ‡æ¢åŠ¨ç”»å±‚
    SwitchWeaponAnimLayer(NewWeapon->AnimLayerClass);
}
```

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹ 1: åŸºç¡€åˆ‡æ¢

1. PIE è¿è¡Œ
2. è°ƒç”¨ `SwitchWeaponAnimLayer(ABP_AnimLayer_Katana)`
3. éªŒè¯ Idle åŠ¨ç”»å˜ä¸ºåˆ€çš„ Idle
4. ç§»åŠ¨ï¼ŒéªŒè¯ä½¿ç”¨åˆ€çš„ BlendSpace

### æµ‹è¯•ç”¨ä¾‹ 2: å¤šæ¬¡åˆ‡æ¢

1. åˆ‡æ¢åˆ°åˆ€: `SwitchWeaponAnimLayer(ABP_AnimLayer_Katana)`
2. åˆ‡æ¢åˆ°å‰‘ç›¾: `SwitchWeaponAnimLayer(ABP_AnimLayer_SwordShield)`
3. æ¸…é™¤: `ClearWeaponAnimLayer()`
4. éªŒè¯æ¯æ¬¡åˆ‡æ¢åŠ¨ç”»æ­£ç¡®

### æµ‹è¯•ç”¨ä¾‹ 3: åœ¨æ”»å‡»ä¸­åˆ‡æ¢

1. å¼€å§‹æ”»å‡» (æ’­æ”¾è’™å¤ªå¥‡)
2. æ”»å‡»ä¸­é€”åˆ‡æ¢æ­¦å™¨
3. éªŒè¯è’™å¤ªå¥‡æ­£å¸¸å®Œæˆ
4. ä¸‹æ¬¡æ”»å‡»ä½¿ç”¨æ–°æ­¦å™¨åŠ¨ç”»

---

## ğŸ“Š å®Œæ•´æ•°æ®æµ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ç©å®¶è¾“å…¥: è£…å¤‡åˆ€    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  EquipWeapon(Katana)â”‚
                    â”‚  æ­¦å™¨æ•°æ®åŒ…å«:       â”‚
                    â”‚  â€¢ AnimLayerClass   â”‚
                    â”‚  â€¢ ComboGraph       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ SwitchWeaponAnimLayerâ”‚
                    â”‚ (ABP_AnimLayer_Katana)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ AnimInstance->       â”‚
                    â”‚ LinkAnimClassLayers()â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ åŠ¨ç”»å±‚æ¿€æ´»          â”‚
                    â”‚ FullBody_IdleState  â”‚
                    â”‚ è¿”å›åˆ€çš„ Idle åŠ¨ç”»   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è§’è‰²æ˜¾ç¤ºåˆ€çš„å¾…æœºå§¿åŠ¿ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å®ç°äº† `SwitchWeaponAnimLayer` å‡½æ•°
- [ ] å®ç°äº† `ClearWeaponAnimLayer` å‡½æ•°
- [ ] å¯ä»¥åœ¨è“å›¾/ä»£ç ä¸­è°ƒç”¨åˆ‡æ¢
- [ ] åˆ‡æ¢ååŠ¨ç”»æ­£ç¡®æ”¹å˜
- [ ] å¤šæ¬¡åˆ‡æ¢ä¸ä¼šå‡ºé”™
- [ ] (å¯é€‰) é›†æˆåˆ°æ­¦å™¨ç³»ç»Ÿ

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q: åˆ‡æ¢ååŠ¨ç”»æ²¡å˜åŒ–ï¼Ÿ

**A**: 
1. æ£€æŸ¥åŠ¨ç”»å±‚æ˜¯å¦æ­£ç¡®å®ç°äº†æ¥å£
2. ç¡®è®¤çŠ¶æ€æœºä½¿ç”¨äº† Linked Anim Layer èŠ‚ç‚¹
3. æ£€æŸ¥åŠ¨ç”»å±‚çš„éª¨éª¼æ˜¯å¦åŒ¹é…

### Q: åˆ‡æ¢æ—¶åŠ¨ç”»è·³å˜ï¼Ÿ

**A**: 
1. åœ¨çŠ¶æ€è½¬æ¢ä¸­è®¾ç½®æ··åˆæ—¶é—´
2. ä½¿ç”¨è¿‡æ¸¡è’™å¤ªå¥‡
3. è€ƒè™‘åœ¨ç§»åŠ¨çŠ¶æ€æ—¶åˆ‡æ¢ï¼ˆIdle åˆ‡æ¢æ›´æ˜æ˜¾ï¼‰

### Q: Unlink ååŠ¨ç”»æ¶ˆå¤±ï¼Ÿ

**A**: 
1. ç¡®ä¿ä¸» ABP æœ‰é»˜è®¤çš„æ¥å£å®ç°
2. ä¸è¦è¿”å›ç©º Pose
3. ä½¿ç”¨ Input Pose ä½œä¸ºåå¤‡

---

## ğŸ‰ æ­å–œå®Œæˆï¼

ä½ å·²ç»å®Œæˆäº†æ•´ä¸ªåŠ¨ç”»è“å›¾ç³»ç»Ÿçš„æ­å»ºï¼

### ä½ ç°åœ¨æ‹¥æœ‰çš„ï¼š

1. âœ… **ä¸»åŠ¨ç”»è“å›¾** - ABP_DJ01Character_Base
2. âœ… **å®Œæ•´çš„çŠ¶æ€æœº** - æ”¯æŒç§»åŠ¨/è·³è·ƒ
3. âœ… **åŠ¨ç”»å±‚ç³»ç»Ÿ** - å¯åˆ‡æ¢çš„æ­¦å™¨åŠ¨ç”»
4. âœ… **BindingSet é›†æˆ** - GAS å±æ€§è‡ªåŠ¨åŒæ­¥
5. âœ… **è¿è¡Œæ—¶åˆ‡æ¢** - LinkAnimClassLayers

### ä¸‹ä¸€æ­¥ï¼š

è¿”å›ä¸»æŒ‡å—ï¼Œç»§ç»­å®Œæˆï¼š
- [05_AbilityScript.md](../05_AbilityScript.md) - AngelScript è¿æ‹›æŠ€èƒ½
- [06_ComboGraph.md](../06_ComboGraph.md) - è¿æ‹›å›¾é…ç½®

ğŸ‘‰ **[è¿”å›è¿æ‹›ç³»ç»Ÿæ€»è§ˆ](../00_Overview.md)**