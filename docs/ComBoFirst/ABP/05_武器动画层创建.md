# 05. æ­¦å™¨åŠ¨ç”»å±‚åˆ›å»º

> **é¢„è®¡è€—æ—¶**: 1 å°æ—¶  
> **å‰ç½®æ¡ä»¶**: å·²å®Œæˆ 03_BlendSpaceåˆ›å»º, 04_åŠ¨ç”»å±‚æ¥å£å®ç°

---

## ğŸ¯ æœ¬ç« ç›®æ ‡

åˆ›å»ºæ­¦å™¨ä¸“å±åŠ¨ç”»å±‚è“å›¾ï¼Œå®ç°ï¼š

1. âœ… åˆ›å»º `ABP_AnimLayer_Unarmed` (ç©ºæ‰‹/è¿‘æˆ˜åŠ¨ç”»å±‚)
2. âœ… åˆ›å»º `ABP_AnimLayer_Katana` (åˆ€åŠ¨ç”»å±‚)
3. âœ… åˆ›å»º `ABP_AnimLayer_Pistol` (æ‰‹æªåŠ¨ç”»å±‚)
4. âœ… å®ç°æ¥å£å‡½æ•°ï¼Œè¿æ¥å¯¹åº”çš„åŠ¨ç”»èµ„äº§

---

## ğŸ“š åŠ¨ç”»å±‚æ¶æ„

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸» ABP (ABP_MainHero)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ çŠ¶æ€æœº: Idle â†â†’ Moving â†â†’ JumpStart â†’ FallLoop â†’ Land  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚ æ¯ä¸ªçŠ¶æ€å†…éƒ¨:                                            â”‚    â”‚
â”‚  â”‚  [Melee Layer] â”€â”¬â”€â†’ Blend by AnimLayerType              â”‚    â”‚
â”‚  â”‚  [Ranged Layer]â”€â”˜                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                           â”‚
   LinkAnimClassLayers()              LinkAnimClassLayers()
                    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ABP_AnimLayer_Unarmed    â”‚    â”‚ ABP_AnimLayer_Pistol     â”‚
â”‚ ABP_AnimLayer_Katana     â”‚    â”‚ ABP_AnimLayer_Rifle      â”‚
â”‚ (å®ç° ALI_MeleeAnimLayers)â”‚    â”‚ (å®ç° ALI_RangedAnimLayers)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç±»ç»§æ‰¿å…³ç³»

```
UAnimInstance
    â””â”€â”€ UDJ01AnimInstance (C++ - æä¾› GroundSpeed, MoveDirection ç­‰)
            â”‚
            â”œâ”€â”€ ABP_MainHero (ä¸»åŠ¨ç”»è“å›¾ - çŠ¶æ€æœºé€»è¾‘)
            â”‚
            â”œâ”€â”€ ABP_AnimLayer_Unarmed (å®ç° ALI_MeleeAnimLayers)
            â”œâ”€â”€ ABP_AnimLayer_Katana  (å®ç° ALI_MeleeAnimLayers)
            â”‚
            â”œâ”€â”€ ABP_AnimLayer_Pistol  (å®ç° ALI_RangedAnimLayers)
            â””â”€â”€ ABP_AnimLayer_Rifle   (å®ç° ALI_RangedAnimLayers)
```

### åŠ¨ç”»å±‚èŒè´£åˆ†å·¥

| è“å›¾ | èŒè´£ | æœ‰çŠ¶æ€æœºï¼Ÿ |
|------|------|-----------|
| **ABP_MainHero** | æ§åˆ¶çŠ¶æ€è½¬æ¢ã€å†³å®šä½•æ—¶åˆ‡æ¢ | âœ… æœ‰ |
| **ABP_AnimLayer_XXX** | æä¾›å…·ä½“åŠ¨ç”»å†…å®¹ | âŒ æ²¡æœ‰ |

---

## ğŸ“ åˆ›å»º ABP_AnimLayer_Unarmed (ç©ºæ‰‹)

è¿™æ˜¯é»˜è®¤çš„è¿‘æˆ˜åŠ¨ç”»å±‚ï¼Œæ¸¸æˆå¼€å§‹æ—¶ä½¿ç”¨ã€‚

### Step 1: åˆ›å»ºåŠ¨ç”»è“å›¾

1. **å¯¼èˆªåˆ°**:
   ```
   Content/Characters/Heroes/HeroAnimations/AnimLayers/
   ```
   (å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œè¯·åˆ›å»º)

2. **å³é”® â†’ Animation â†’ Animation Blueprint**

3. **é€‰æ‹©è®¾ç½®**:
   - Parent Class: **`DJ01AnimInstance`** â† ç»§æ‰¿ä»¥è·å–å˜é‡
   - Target Skeleton: ä½ çš„è§’è‰²éª¨éª¼

4. **å‘½åä¸º**: `ABP_AnimLayer_Unarmed`

5. **åŒå‡»æ‰“å¼€**

---

### Step 2: æ·»åŠ åŠ¨ç”»å±‚æ¥å£

1. **ç‚¹å‡» Class Settings**

2. **åœ¨ Interfaces â†’ Implemented Interfaces éƒ¨åˆ†**:
   - ç‚¹å‡» `Add`
   - æœç´¢ `ALI_MeleeAnimLayers`
   - é€‰æ‹©æ·»åŠ 

3. **ç¼–è¯‘è“å›¾**

4. **ç¡®è®¤æ¥å£å‡½æ•°å‡ºç°**ï¼ˆåœ¨å·¦ä¾§ My Blueprint â†’ Interfaces ä¸‹ï¼‰

---

### Step 3: å®ç°æ¥å£å‡½æ•°

#### Melee_IdleState

```
[Sequence Player: MM_Unarmed_Idle_Ready]  â†’  [Return Node]
         â”‚
    Loop: âœ… True
```

åŠ¨ç”»è·¯å¾„: `Characters/Heroes/Mannequin_Mesh/Animations/Locomotion/Unarmed/MM_Unarmed_Idle_Ready`

#### Melee_MovingState

```
[BlendSpace Player: BS_Unarmed_Locomotion]  â†’  [Return Node]
         â”‚
    Direction â† MoveDirection
    Speed â† GroundSpeed
```

> å¦‚æœè¿˜æ²¡åˆ›å»º BlendSpaceï¼Œå¯ä»¥å…ˆç”¨ç®€å•åŠ¨ç”»: `MF_Unarmed_Jog_Fwd`

#### Melee_JumpStartState (å€Ÿç”¨ Pistol)

```
[Sequence Player: MM_Pistol_Jump_Start]  â†’  [Return Node]
         â”‚
    Loop: âŒ False
```

#### Melee_FallLoopState (å€Ÿç”¨ Pistol)

```
[Sequence Player: MM_Pistol_Jump_Fall_Loop]  â†’  [Return Node]
         â”‚
    Loop: âœ… True
```

#### Melee_LandState (å€Ÿç”¨ Pistol)

```
[Sequence Player: MM_Pistol_Jump_Fall_Land]  â†’  [Return Node]
         â”‚
    Loop: âŒ False
```

---

## ğŸ“ åˆ›å»º ABP_AnimLayer_Katana (åˆ€)

### Step 1: åˆ›å»ºåŠ¨ç”»è“å›¾

1. å³é”® â†’ Animation â†’ Animation Blueprint
2. Parent Class: `DJ01AnimInstance`
3. å‘½åä¸º: `ABP_AnimLayer_Katana`

### Step 2: æ·»åŠ æ¥å£

- æ·»åŠ  `ALI_MeleeAnimLayers` æ¥å£
- ç¼–è¯‘

### Step 3: å®ç°æ¥å£å‡½æ•°

#### åŠ¨ç”»èµ„æºä½ç½®

```
Content/AnimAssetsCombatMasterAnimBundle/Animations/DynamicKatanaAnimsV3/RootMotion/
â”œâ”€â”€ Idle/Anim_KT3_Idle_RM
â”œâ”€â”€ Locomotion/Anim_KT3_Walk_F/B/L/R/FL/FR/BL/BR_RM
â”œâ”€â”€ Locomotion/Anim_KT3_Run_F/B/L/R/FL/FR/BL/BR_RM
â””â”€â”€ Attack/Anim_KT3_Combo_* (æ”»å‡»åŠ¨ç”»)
```

#### Melee_IdleState

```
[Sequence Player: Anim_KT3_Idle_RM]  â†’  [Return Node]
         â”‚
    Loop: âœ… True
```

#### Melee_MovingState

```
[BlendSpace Player: BS_Katana_Locomotion]  â†’  [Return Node]
         â”‚
    Direction â† MoveDirection
    Speed â† GroundSpeed
```

> âš ï¸ éœ€è¦å…ˆåˆ›å»º `BS_Katana_Locomotion`ï¼Œå‚è€ƒ 03_BlendSpaceåˆ›å»º.md

#### è·³è·ƒç›¸å…³ (å€Ÿç”¨ Pistol)

| å‡½æ•° | åŠ¨ç”» |
|------|------|
| `Melee_JumpStartState` | `MM_Pistol_Jump_Start` |
| `Melee_FallLoopState` | `MM_Pistol_Jump_Fall_Loop` |
| `Melee_LandState` | `MM_Pistol_Jump_Fall_Land` |

---

## ğŸ“ åˆ›å»º ABP_AnimLayer_Pistol (æ‰‹æª)

### Step 1: åˆ›å»ºåŠ¨ç”»è“å›¾

1. å³é”® â†’ Animation â†’ Animation Blueprint
2. Parent Class: `DJ01AnimInstance`
3. å‘½åä¸º: `ABP_AnimLayer_Pistol`

### Step 2: æ·»åŠ æ¥å£

- æ·»åŠ  **`ALI_RangedAnimLayers`** æ¥å£ â† æ³¨æ„æ˜¯ Rangedï¼
- ç¼–è¯‘

### Step 3: å®ç°æ¥å£å‡½æ•°

#### åŠ¨ç”»èµ„æºä½ç½®

```
Content/Characters/Heroes/Mannequin_Mesh/Animations/Locomotion/Pistol/
â”œâ”€â”€ MM_Pistol_Idle_Hipfire (Idle)
â”œâ”€â”€ MM_Pistol_Walk_Fwd/Bwd/Left/Right
â”œâ”€â”€ MM_Pistol_Jog_Fwd/Bwd/Left/Right
â”œâ”€â”€ MM_Pistol_Jump_Start
â”œâ”€â”€ MM_Pistol_Jump_Fall_Loop
â””â”€â”€ MM_Pistol_Jump_Fall_Land
```

#### Ranged_IdleState

```
[Sequence Player: MM_Pistol_Idle_Hipfire]  â†’  [Return Node]
         â”‚
    Loop: âœ… True
```

#### Ranged_MovingState

```
[BlendSpace Player: BS_Pistol_Locomotion]  â†’  [Return Node]
         â”‚
    Direction â† MoveDirection
    Speed â† GroundSpeed
```

#### Ranged_JumpStartState

```
[Sequence Player: MM_Pistol_Jump_Start]  â†’  [Return Node]
```

#### Ranged_FallLoopState

```
[Sequence Player: MM_Pistol_Jump_Fall_Loop]  â†’  [Return Node]
         â”‚
    Loop: âœ… True
```

#### Ranged_LandState

```
[Sequence Player: MM_Pistol_Jump_Fall_Land]  â†’  [Return Node]
```

---

## ğŸ“Š åŠ¨ç”»å±‚æ±‡æ€»è¡¨

| åŠ¨ç”»å±‚ | æ¥å£ | Idle | Moving | Jump |
|--------|------|------|--------|------|
| `ABP_AnimLayer_Unarmed` | `ALI_MeleeAnimLayers` | `MM_Unarmed_Idle_Ready` | BlendSpace | å€Ÿç”¨ Pistol |
| `ABP_AnimLayer_Katana` | `ALI_MeleeAnimLayers` | `Anim_KT3_Idle_RM` | BlendSpace (8æ–¹å‘) | å€Ÿç”¨ Pistol |
| `ABP_AnimLayer_Pistol` | `ALI_RangedAnimLayers` | `MM_Pistol_Idle_Hipfire` | BlendSpace (4æ–¹å‘) | âœ… è‡ªæœ‰ |
| `ABP_AnimLayer_Rifle` | `ALI_RangedAnimLayers` | `MM_Rifle_Idle_Hipfire` | BlendSpace (4æ–¹å‘) | âœ… è‡ªæœ‰ |

---

## ï¿½ è¿æ¥åŠ¨ç”»å±‚åˆ°è§’è‰²

### åœ¨è§’è‰²è“å›¾ä¸­è¿æ¥ (BeginPlay)

```
[Event BeginPlay]
       â”‚
       â–¼
[Get Mesh] â†’ [Get Anim Instance] â†’ [Link Anim Class Layers]
                                          â”‚
                                   In Class: ABP_AnimLayer_Unarmed
```

### åœ¨ C++ ä¸­è¿æ¥

```cpp
void ADJ01Character::BeginPlay()
{
    Super::BeginPlay();
    
    if (UAnimInstance* AnimInstance = GetMesh()->GetAnimInstance())
    {
        // é»˜è®¤ä½¿ç”¨ Unarmed
        AnimInstance->LinkAnimClassLayers(ABP_AnimLayer_Unarmed::StaticClass());
    }
}
```

### åˆ‡æ¢åŠ¨ç”»å±‚ (è£…å¤‡æ­¦å™¨æ—¶)

```cpp
void ADJ01Character::EquipWeapon(TSubclassOf<UAnimInstance> NewLayerClass)
{
    UAnimInstance* AnimInstance = GetMesh()->GetAnimInstance();
    if (!AnimInstance) return;
    
    // è§£é™¤å½“å‰é“¾æ¥
    if (CurrentMeleeLayerClass)
    {
        AnimInstance->UnlinkAnimClassLayers(CurrentMeleeLayerClass);
    }
    
    // é“¾æ¥æ–°çš„åŠ¨ç”»å±‚
    AnimInstance->LinkAnimClassLayers(NewLayerClass);
    CurrentMeleeLayerClass = NewLayerClass;
}
```

---

## ğŸ“ æœ€ç»ˆæ–‡ä»¶ç»“æ„

```
Content/Characters/Heroes/HeroAnimations/
â”œâ”€â”€ ABP_MainHero.uasset                    â† ä¸»åŠ¨ç”»è“å›¾
â”œâ”€â”€ AnimLayers/
â”‚   â”œâ”€â”€ ABP_AnimLayer_Unarmed.uasset       â† ç©ºæ‰‹ (è¿‘æˆ˜)
â”‚   â”œâ”€â”€ ABP_AnimLayer_Katana.uasset        â† åˆ€ (è¿‘æˆ˜)
â”‚   â”œâ”€â”€ ABP_AnimLayer_Pistol.uasset        â† æ‰‹æª (è¿œç¨‹)
â”‚   â””â”€â”€ ABP_AnimLayer_Rifle.uasset         â† æ­¥æª (è¿œç¨‹)
â”œâ”€â”€ BlendSpaces/
â”‚   â”œâ”€â”€ BS_Unarmed_Locomotion.uasset
â”‚   â”œâ”€â”€ BS_Katana_Locomotion.uasset
â”‚   â”œâ”€â”€ BS_Pistol_Locomotion.uasset
â”‚   â””â”€â”€ BS_Rifle_Locomotion.uasset
â””â”€â”€ Interfaces/
    â”œâ”€â”€ ALI_MeleeAnimLayers.uasset         â† è¿‘æˆ˜æ¥å£
    â””â”€â”€ ALI_RangedAnimLayers.uasset        â† è¿œç¨‹æ¥å£
```

---

## ğŸ§ª æµ‹è¯•åŠ¨ç”»å±‚

1. **åœ¨è§’è‰²è“å›¾ BeginPlay ä¸­é“¾æ¥åŠ¨ç”»å±‚**

2. **PIE è¿è¡Œæ¸¸æˆ**

3. **éªŒè¯**:
   - Idle çŠ¶æ€æ’­æ”¾æ­£ç¡®åŠ¨ç”»
   - ç§»åŠ¨æ—¶ BlendSpace æ­£å¸¸å·¥ä½œ
   - è·³è·ƒ/è½åœ°åŠ¨ç”»æ­£å¸¸

4. **åˆ‡æ¢æµ‹è¯•** (å¦‚æœå®ç°äº†åˆ‡æ¢é€»è¾‘):
   - æŒ‰é”®åˆ‡æ¢æ­¦å™¨
   - è§‚å¯ŸåŠ¨ç”»æ˜¯å¦æ­£ç¡®åˆ‡æ¢

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] åˆ›å»ºäº† `ABP_AnimLayer_Unarmed` (ç»§æ‰¿ DJ01AnimInstance)
- [ ] åˆ›å»ºäº† `ABP_AnimLayer_Katana` (ç»§æ‰¿ DJ01AnimInstance)
- [ ] å®ç°äº†æ‰€æœ‰å¿…éœ€çš„æ¥å£å‡½æ•° (Idle, Moving, Jump, Fall, Land)
- [ ] BlendSpace æ­£ç¡®é…ç½®å¹¶è¿æ¥
- [ ] åœ¨è§’è‰² BeginPlay ä¸­è°ƒç”¨äº† LinkAnimClassLayers
- [ ] PIE æµ‹è¯•åŠ¨ç”»æ­£å¸¸æ’­æ”¾
- [ ] ç¼–è¯‘æ— é”™è¯¯

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q: åŠ¨ç”»å±‚æ— æ³•è·å– GroundSpeed å˜é‡ï¼Ÿ

**A**: ç¡®ä¿åŠ¨ç”»å±‚ç»§æ‰¿è‡ª `DJ01AnimInstance`ï¼Œè€Œä¸æ˜¯æ™®é€šçš„ `AnimInstance`ã€‚

### Q: Link ååŠ¨ç”»ä¸æ’­æ”¾ï¼Ÿ

**A**: 
1. æ£€æŸ¥ä¸» ABP çŠ¶æ€æœºæ˜¯å¦ä½¿ç”¨äº† Linked Anim Layer èŠ‚ç‚¹
2. ç¡®ä¿æ¥å£å‡½æ•°éƒ½æœ‰ Return Node è¿æ¥
3. æ£€æŸ¥åŠ¨ç”»èµ„äº§æ˜¯å¦æœ‰æ•ˆ

### Q: åˆ‡æ¢æ­¦å™¨ååŠ¨ç”»æ··ä¹±ï¼Ÿ

**A**: 
1. åˆ‡æ¢å‰å…ˆ `UnlinkAnimClassLayers` æ—§çš„
2. å† `LinkAnimClassLayers` æ–°çš„
3. åŒä¸€æ¥å£åªèƒ½é“¾æ¥ä¸€ä¸ªå®ç°

### Q: BlendSpace ä¸å“åº”è¾“å…¥ï¼Ÿ

**A**: 
1. æ£€æŸ¥ MoveDirection å’Œ GroundSpeed æ˜¯å¦æ­£ç¡®æ›´æ–°
2. åœ¨ AnimGraph ä¸­æ‰“å°è¿™äº›å˜é‡çš„å€¼è°ƒè¯•

---

## ğŸ“ ä¸‹ä¸€æ­¥

æ­¦å™¨åŠ¨ç”»å±‚åˆ›å»ºå®Œæˆï¼æ¥ä¸‹æ¥å­¦ä¹ å¦‚ä½•åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢åŠ¨ç”»å±‚ã€‚

ğŸ‘‰ **[è¿›å…¥ç¬¬å…­ç« ï¼šBindingSeté›†æˆ](./06_BindingSeté›†æˆ.md)**  
ğŸ‘‰ **[æˆ–è¿›å…¥ç¬¬ä¸ƒç« ï¼šåŠ¨ç”»å±‚åˆ‡æ¢](./07_åŠ¨ç”»å±‚åˆ‡æ¢.md)**