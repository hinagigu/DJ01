# 02a. åˆ›å»ºåŠ¨ç”»å±‚æ¥å£ (Animation Layer Interface)

> **é¢„è®¡è€—æ—¶**: 30 åˆ†é’Ÿ  
> **å‰ç½®æ¡ä»¶**: å·²å®Œæˆ 01_åˆ›å»ºä¸»åŠ¨ç”»è“å›¾

---

## ğŸ¯ æœ¬ç« ç›®æ ‡

åˆ›å»ºå¯åˆ‡æ¢çš„åŠ¨ç”»å±‚æ¥å£ï¼Œæ”¯æŒï¼š

1. âœ… è¿‘æˆ˜æ­¦å™¨åŠ¨ç”»å±‚ (`ALI_MeleeAnimLayers`)
2. âœ… è¿œç¨‹æ­¦å™¨åŠ¨ç”»å±‚ (`ALI_RangedAnimLayers`)
3. âœ… è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢

---

## âš ï¸ é‡è¦ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç”¨ C++ å®šä¹‰ï¼Ÿ

ç»è¿‡æ·±å…¥åˆ†æ UE5 å¼•æ“æºç ï¼Œæˆ‘ä»¬å‘ç°ï¼š

### æŠ€æœ¯é™åˆ¶

1. **`FPoseLink` æ˜¯ AnimGraph ä¸“ç”¨ç±»å‹**
   - éœ€è¦ AnimGraph ä¸Šä¸‹æ–‡æ‰èƒ½è¯„ä¼°
   - C++ å‡½æ•°è¿”å› `FPoseLink` ä¼šè¢«æ ‡è®°ä¸º "Impure"
   - AnimGraph èŠ‚ç‚¹è¦æ±‚ "Pure" å‡½æ•°

2. **å¼•æ“éªŒè¯é€»è¾‘**ï¼ˆæ¥è‡ª `AnimGraphNode_LinkedAnimLayer.cpp`ï¼‰ï¼š
   ```cpp
   // ç¬¬ 598 è¡Œ
   InterfaceDesc.Interface->IsChildOf<UAnimLayerInterface>()
   ```
   å¼•æ“åªæ¥å—ç»§æ‰¿è‡ª `UAnimLayerInterface` çš„è“å›¾æ¥å£èµ„äº§

3. **Animation Layer å‡½æ•°æ˜¯ç‰¹æ®Šçš„ AnimGraph å‡½æ•°**
   - ä¸æ˜¯æ™®é€šçš„ `UFUNCTION`
   - åœ¨è“å›¾ Animation Layer Interface ç¼–è¾‘å™¨ä¸­åˆ›å»º
   - æ¯ä¸ªå‡½æ•°å¯¹åº”ä¸€ä¸ª AnimGraph å­å›¾

### ç»“è®º

**Animation Layer Interface å¿…é¡»ä½¿ç”¨è“å›¾èµ„äº§åˆ›å»ºï¼**

---

## ğŸ“ è¯¦ç»†æ­¥éª¤

### Step 1: åˆ›å»º ALI_MeleeAnimLayers

1. **å†…å®¹æµè§ˆå™¨** â†’ å³é”® â†’ `Animation` â†’ `Animation Layer Interface`

2. å‘½åä¸º `ALI_MeleeAnimLayers`

3. ä¿å­˜ä½ç½®å»ºè®®ï¼š`/Content/Characters/Animation/Interfaces/`

4. **åŒå‡»æ‰“å¼€** æ¥å£ç¼–è¾‘å™¨

5. åœ¨ **My Blueprint** é¢æ¿ä¸­æ·»åŠ  Animation Layerï¼š

   å³é”® â†’ `Add New` â†’ é€‰æ‹©æ·»åŠ å‡½æ•°ï¼ˆAnimation Layer ç±»å‹ä¼šè‡ªåŠ¨æ­£ç¡®ï¼‰

6. æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š

   **Locomotion å±‚**:
   - `Melee_IdleState`
   - `Melee_MovingState`
   - `Melee_SprintState`

   **Jump å±‚**:
   - `Melee_JumpStartState`
   - `Melee_FallLoopState`
   - `Melee_LandState`

   **Combat å±‚**:
   - `Melee_BlockState`
   - `Melee_DodgeState`
   - `Melee_HitReactState`
   - `Melee_KnockdownState`
   - `Melee_GetUpState`

   **Weapon å±‚**:
   - `Melee_DrawWeaponState`
   - `Melee_SheathWeaponState`

7. **ç¼–è¯‘å¹¶ä¿å­˜**

### Step 2: åˆ›å»º ALI_RangedAnimLayers

é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œåˆ›å»º `ALI_RangedAnimLayers`ï¼š

**Locomotion å±‚**:
- `Ranged_IdleState`
- `Ranged_MovingState`
- `Ranged_SprintState`

**Jump å±‚**:
- `Ranged_JumpStartState`
- `Ranged_FallLoopState`
- `Ranged_LandState`

**Aiming å±‚**ï¼ˆå°„å‡»ç‰¹æœ‰ï¼‰:
- `Ranged_AimingIdleState`
- `Ranged_AimingMovingState`
- `Ranged_HipfireState`

**Reload å±‚**:
- `Ranged_ReloadState`

### Step 3: ä¸» ABP å®ç°æ¥å£

1. æ‰“å¼€ `ABP_DJ01Character_Base`

2. **Class Settings** â†’ **Interfaces** â†’ **Add**

3. æ·»åŠ  `ALI_MeleeAnimLayers` å’Œ `ALI_RangedAnimLayers`

4. **ç¼–è¯‘**

5. åœ¨ AnimGraph çŠ¶æ€ä¸­ï¼Œå³é”®æœç´¢ `Linked Anim Layer`ï¼Œç°åœ¨å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ¥å£å‡½æ•°

---

## ğŸ—ï¸ æ¥å£æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ABP_DJ01Character_Base                            â”‚
â”‚                    (ä¸»åŠ¨ç”»è“å›¾)                                       â”‚
â”‚                                                                     â”‚
â”‚  Implements:                                                        â”‚
â”‚    â€¢ ALI_MeleeAnimLayers   (è“å›¾æ¥å£)                                â”‚
â”‚    â€¢ ALI_RangedAnimLayers  (è“å›¾æ¥å£)                                â”‚
â”‚    â€¢ ALI_ItemAnimLayers    (Lyra è“å›¾æ¥å£ï¼Œå¦‚éœ€è¦)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                                                                    â”‚
                              LinkAnimClassLayers() è¿è¡Œæ—¶åˆ‡æ¢        â”‚
                                                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ABP_Layer_Katana  â”‚   â”‚ ABP_Layer_Pistol  â”‚
â”‚ (å®ç°è¿‘æˆ˜æ¥å£)     â”‚   â”‚ (å®ç°è¿œç¨‹æ¥å£)     â”‚
â”‚                   â”‚   â”‚                   â”‚
â”‚ Melee_IdleState   â”‚   â”‚ Ranged_IdleState  â”‚
â”‚   â†’ å±…åˆç«™å§¿åŠ¨ç”»   â”‚   â”‚   â†’ æŒæªç«™å§¿åŠ¨ç”»   â”‚
â”‚ Melee_MovingState â”‚   â”‚ Ranged_MovingStateâ”‚
â”‚   â†’ å±…åˆç§»åŠ¨åŠ¨ç”»   â”‚   â”‚   â†’ æŒæªç§»åŠ¨åŠ¨ç”»   â”‚
â”‚ ...               â”‚   â”‚ ...               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å…³äº C++ ä»£ç çš„å¤„ç†

ç”±äºæˆ‘ä»¬ä¹‹å‰åˆ›å»ºäº† C++ æ¥å£æ–‡ä»¶ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹å¤„ç†ï¼š

### é€‰é¡¹ A: åˆ é™¤ C++ æ¥å£ï¼ˆæ¨èï¼‰

åˆ é™¤ä»¥ä¸‹æ–‡ä»¶ï¼š
- `Source/DJ01/Animation/ALI_MeleeAnimLayers.h`
- `Source/DJ01/Animation/ALI_MeleeAnimLayers.cpp`ï¼ˆå¦‚å­˜åœ¨ï¼‰
- `Source/DJ01/Animation/ALI_RangedAnimLayers.h`
- `Source/DJ01/Animation/ALI_RangedAnimLayers.cpp`ï¼ˆå¦‚å­˜åœ¨ï¼‰

### é€‰é¡¹ B: ä¿ç•™ C++ ç”¨äºå…¶ä»–ç›®çš„

å¦‚æœéœ€è¦ä¿ç•™ C++ æ¥å£ç”¨äºå…¶ä»–é€»è¾‘ï¼ˆå¦‚æ­¦å™¨åˆ‡æ¢é€šçŸ¥ï¼‰ï¼Œå¯ä»¥å°†å…¶è½¬æ¢ä¸ºéåŠ¨ç”»æ¥å£ï¼š

```cpp
// ä¿ç•™ç”¨äºé€šç”¨æ­¦å™¨é€»è¾‘ï¼Œä½†åˆ é™¤ FPoseLink ç›¸å…³å‡½æ•°
UINTERFACE(BlueprintType, meta = (DisplayName = "Melee Weapon Interface"))
class UALI_MeleeWeaponInterface : public UInterface
{
    GENERATED_BODY()
};

class DJ01_API IALI_MeleeWeaponInterface
{
    GENERATED_BODY()

public:
    // éåŠ¨ç”»ç›¸å…³çš„æ¥å£å‡½æ•°
    UFUNCTION(BlueprintNativeEvent, BlueprintCallable, Category = "Melee")
    void OnWeaponDrawn();
    
    UFUNCTION(BlueprintNativeEvent, BlueprintCallable, Category = "Melee")
    void OnWeaponSheathed();
};
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### éªŒè¯æ¥å£åˆ›å»ºæˆåŠŸ

1. æ‰“å¼€ `ABP_DJ01Character_Base`
2. è¿›å…¥ä»»æ„çŠ¶æ€çš„ AnimGraphï¼ˆå¦‚ Idle çŠ¶æ€ï¼‰
3. å³é”® â†’ æœç´¢ `Linked Anim Layer`
4. åº”è¯¥èƒ½çœ‹åˆ° `Melee_IdleState`ã€`Ranged_IdleState` ç­‰å‡½æ•°

### å¸¸è§é—®é¢˜

**Q: æœç´¢ Linked Anim Layer ä½†åˆ—è¡¨ä¸ºç©ºï¼Ÿ**

A: ç¡®ä¿ï¼š
1. æ¥å£æ˜¯ **Animation Layer Interface** ç±»å‹ï¼ˆä¸æ˜¯æ™®é€š Blueprint Interfaceï¼‰
2. å·²åœ¨ Class Settings ä¸­æ·»åŠ æ¥å£
3. å·²ç¼–è¯‘å¹¶ä¿å­˜

**Q: æ˜¾ç¤º "Target graph does not support Impure functions"ï¼Ÿ**

A: è¿™è¯´æ˜ä½ ä½¿ç”¨çš„æ˜¯ C++ æ¥å£ã€‚è¯·ä½¿ç”¨è“å›¾ Animation Layer Interface èµ„äº§ã€‚

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] åˆ›å»ºäº† `ALI_MeleeAnimLayers` è“å›¾æ¥å£èµ„äº§
- [ ] åˆ›å»ºäº† `ALI_RangedAnimLayers` è“å›¾æ¥å£èµ„äº§
- [ ] æ¯ä¸ªæ¥å£åŒ…å«æ‰€éœ€çš„ Animation Layer å‡½æ•°
- [ ] ä¸» ABP å·²å®ç°è¿™äº›æ¥å£
- [ ] åœ¨ AnimGraph ä¸­å¯ä»¥æœç´¢åˆ° Linked Anim Layer èŠ‚ç‚¹
- [ ] åˆ é™¤æˆ–é‡æ„äº†ä¹‹å‰çš„ C++ æ¥å£æ–‡ä»¶

---

## ğŸ“ ä¸‹ä¸€æ­¥

æ¥å£åˆ›å»ºå®Œæˆï¼è¿”å›çŠ¶æ€æœºè®¾è®¡ç»§ç»­é…ç½®çŠ¶æ€ã€‚

ğŸ‘‰ **[è¿”å›ç¬¬äºŒç« ï¼šçŠ¶æ€æœºè®¾è®¡](./02_çŠ¶æ€æœºè®¾è®¡.md)**