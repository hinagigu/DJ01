# 03c. Root Motion 与根锁定详解

> **目标**: 理解 Root Motion 系统和根锁定设置，解决动画回弹、脚滑等常见问题
> **适用场景**: 移动动画配置、攻击动画配置、第三方动画资源适配

---

## 🎯 什么是 Root Motion

**Root Motion** 是指动画中 **根骨骼 (Root Bone)** 的位移和旋转数据驱动角色移动的技术。

```
┌─────────────────────────────────────────────────────────────────┐
│  两种角色移动方式对比                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  【方式 A: 代码/物理驱动】                                       │
│  CharacterMovement 组件计算位移 → 角色移动                       │
│  动画只负责播放姿势，不控制位置                                   │
│  ✅ 适合: 移动、跳跃、常规移动                                   │
│                                                                  │
│  【方式 B: Root Motion 驱动】                                    │
│  动画中的 Root 骨骼位移数据 → 驱动角色移动                        │
│  动画师精确控制每一帧的位置                                       │
│  ✅ 适合: 攻击位移、翻滚、处决动画                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Root Motion 的优势

| 场景 | 使用 Root Motion | 不使用 Root Motion |
|------|-----------------|-------------------|
| 攻击前冲 | ✅ 精确控制冲刺距离 | ❌ 动画和位移不同步 |
| 翻滚闪避 | ✅ 动画和位移完美匹配 | ❌ 脚滑或位移不自然 |
| 常规移动 | ❌ 难以响应玩家输入 | ✅ 灵活控制速度方向 |

---

## 📋 动画序列中的 Root Motion 设置

打开任意动画序列，在 **Asset Details** 面板可以看到以下设置：

```
┌─────────────────────────────────────────────────────────────────┐
│  ▼ 根运动 (Root Motion)                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  启用根运动 (Enable Root Motion)     ☐                          │
│                                                                  │
│  根运动根锁定 (Root Motion Root Lock)   参考姿势 ▼               │
│                                                                  │
│  强制根锁定 (Force Root Lock)        ☐                          │
│                                                                  │
│  使用标准化根运动范围                  ☑                          │
│  (Use Normalized Root Motion Scale)                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔍 各设置详解

### 1. 启用根运动 (Enable Root Motion)

**作用**: 是否将动画中 Root 骨骼的位移/旋转数据提取出来，用于驱动角色移动。

| 设置 | 效果 |
|------|------|
| ☑ 启用 | Root 骨骼的位移会被提取，可以驱动角色移动 |
| ☐ 禁用 | Root 骨骼的位移被忽略，角色位置由代码控制 |

**典型用法**:
- **攻击动画**: ☑ 启用 (让角色跟随动画前冲)
- **移动动画**: ☐ 禁用 (让 CharacterMovement 控制)

---

### 2. 根运动根锁定 (Root Motion Root Lock)

**作用**: 当 **不使用 Root Motion** 时，Root 骨骼应该锁定在什么位置。

```
┌─────────────────────────────────────────────────────────────────┐
│  根锁定位置选项                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  【参考姿势 (Ref Pose)】                                        │
│  ┌────────────────────────────────────────┐                     │
│  │                                        │                     │
│  │    锁定到骨架的 T-Pose/A-Pose 原点     │                     │
│  │    通常是 (0, 0, 0)                    │                     │
│  │                                        │                     │
│  │    ✅ 推荐用于: 大多数情况             │                     │
│  │                                        │                     │
│  └────────────────────────────────────────┘                     │
│                                                                  │
│  【动画首帧 (Anim First Frame)】                                │
│  ┌────────────────────────────────────────┐                     │
│  │                                        │                     │
│  │    锁定到动画第一帧时 Root 骨骼的位置   │                     │
│  │    如果首帧 Root 在 (10, 0, 5)         │                     │
│  │    则整个动画都锁在那个位置             │                     │
│  │                                        │                     │
│  │    ✅ 推荐用于: 有预备姿势的动画       │                     │
│  │                                        │                     │
│  └────────────────────────────────────────┘                     │
│                                                                  │
│  【0帧 (Zero)】                                                  │
│  ┌────────────────────────────────────────┐                     │
│  │                                        │                     │
│  │    强制锁定到世界原点 (0, 0, 0)        │                     │
│  │                                        │                     │
│  │    ⚠️ 很少使用                         │                     │
│  │                                        │                     │
│  └────────────────────────────────────────┘                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**参考姿势 vs 动画首帧 对比**:

```
场景: 一个 Run 动画，首帧 Root 骨骼在 (50, 0, 0)

【参考姿势】                     【动画首帧】
     ↓                              ↓
  角色在原点播放动画             角色偏移 50 单位后播放
     ●                              ●
    /|\                            /|\
    / \                            / \
  ───┼───                        ───┼───
   原点                          偏移位置
```

---

### 3. 强制根锁定 (Force Root Lock) ⭐

**作用**: **强制** 将 Root 骨骼锁定在指定位置，**无论动画数据中 Root 骨骼如何移动**。

```
┌─────────────────────────────────────────────────────────────────┐
│  强制根锁定 = 你的"回弹问题救星"                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  问题场景:                                                       │
│  ┌────────────────────────────────────────┐                     │
│  │                                        │                     │
│  │  动画中 Root 骨骼有位移曲线:           │                     │
│  │                                        │                     │
│  │  帧 0:   Root 在 (0, 0, 0)            │                     │
│  │  帧 15:  Root 在 (100, 0, 0) ← 向前移 │                     │
│  │  帧 30:  Root 在 (0, 0, 0)   ← 回到原点│                     │
│  │                                        │                     │
│  │  循环播放时 → 角色看起来"走了又弹回"   │                     │
│  │                                        │                     │
│  └────────────────────────────────────────┘                     │
│                                                                  │
│  解决方案: ☑ 强制根锁定                                         │
│  ┌────────────────────────────────────────┐                     │
│  │                                        │                     │
│  │  无论动画中 Root 怎么移动              │                     │
│  │  都强制锁定在参考姿势/首帧位置         │                     │
│  │                                        │                     │
│  │  帧 0-30: Root 始终在 (0, 0, 0) ✅     │                     │
│  │                                        │                     │
│  └────────────────────────────────────────┘                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**为什么动画会有这种"回弹"数据？**

1. **动画师的工作方式**: 在 DCC 软件 (Maya/Blender) 中，动画师可能让角色实际移动来制作动画
2. **Root Motion 动画**: 这些动画本意是用 Root Motion 驱动角色的，但你用代码驱动时就冲突了
3. **循环点不匹配**: 动画结束帧和开始帧的 Root 位置不一致

---

### 4. 使用标准化根运动范围 (Use Normalized Root Motion Scale)

**作用**: 将 Root Motion 的位移数据标准化到 0-1 范围，便于在不同速度下缩放。

| 设置 | 效果 |
|------|------|
| ☑ 启用 | Root Motion 位移会被归一化，可以乘以速度系数 |
| ☐ 禁用 | 使用原始的绝对位移值 |

**一般保持默认 ☑ 即可。**

---

## 🎮 Animation Blueprint 中的 Root Motion 设置

在 **Animation Blueprint** 的 **Class Settings** 中：

```
┌─────────────────────────────────────────────────────────────────┐
│  ABP Class Settings → Root Motion Mode                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  【No Root Motion Extraction】                                  │
│  完全不提取任何动画的 Root Motion                               │
│                                                                  │
│  【Ignore Root Motion】                                         │
│  提取但忽略，不应用到角色移动                                    │
│                                                                  │
│  【Root Motion from Everything】                  ⚠️ 慎用       │
│  所有动画的 Root Motion 都会驱动角色                            │
│                                                                  │
│  【Root Motion from Montages Only】               ✅ 推荐       │
│  只有 Montage 中的动画会使用 Root Motion                        │
│  普通状态机/BlendSpace 中的动画不使用                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 推荐配置

```
┌─────────────────────────────────────────────────────────────────┐
│  动画类型          │ Root Motion │ 播放方式                     │
├───────────────────┼─────────────┼─────────────────────────────┤
│  移动 (Locomotion)│     ❌      │ BlendSpace / 状态机         │
│  攻击 (Attack)    │     ✅      │ Montage                     │
│  翻滚 (Dodge)     │     ✅      │ Montage                     │
│  受击 (Hit React) │     ✅      │ Montage                     │
│  处决 (Finisher)  │     ✅      │ Montage                     │
└─────────────────────────────────────────────────────────────────┘

ABP 设置: Root Motion from Montages Only
```

---

## 🔧 常见问题与解决方案

### 问题 1: 角色走着走着跳回一小段

**原因**: 动画的 Root 骨骼有位移数据，循环时跳回起点

**解决**: 
```
动画序列 → 强制根锁定 ☑
```

---

### 问题 2: 角色移动时脚滑

**原因**: CharacterMovement 速度和动画播放速度不匹配

**解决**:
1. 调整 BlendSpace 的 Speed 轴范围匹配角色实际速度
2. 或调整角色的 Max Walk Speed

---

### 问题 3: 攻击时角色不前冲

**原因**: ABP 设置为忽略 Root Motion，或动画没启用 Root Motion

**解决**:
```
1. ABP → Root Motion Mode → Root Motion from Montages Only
2. 攻击动画 → Enable Root Motion ☑
3. 使用 Montage 播放攻击动画
```

---

### 问题 4: 攻击前冲距离不对

**原因**: Character Blueprint 的 Root Motion 处理设置

**解决**:
```
Character Blueprint → CharacterMovement 组件:
  └ Root Motion Source: Root Motion From Everything
```

---

## 📋 配置速查表

### 移动动画 (Locomotion)

| 设置项 | 值 |
|--------|-----|
| 动画序列 → 启用根运动 | ☐ |
| 动画序列 → 强制根锁定 | ☑ |
| 动画序列 → 根锁定位置 | 参考姿势 |
| ABP → Root Motion Mode | Montages Only |

### 攻击动画 (Attack)

| 设置项 | 值 |
|--------|-----|
| 动画序列 → 启用根运动 | ☑ |
| 动画序列 → 强制根锁定 | ☐ |
| ABP → Root Motion Mode | Montages Only |
| 播放方式 | Montage |

---

## 🎯 你的 Katana 动画配置建议

根据你的项目结构 (`DynamicKatanaAnimsV3/RootMotion/`)：

### Locomotion 目录下的动画
```
路径: RootMotion/Locomotion/Anim_KT3_Walk_*_RM.uasset
     RootMotion/Locomotion/Anim_KT3_Run_*_RM.uasset

设置:
  ├ 启用根运动: ☐
  ├ 根运动根锁定: 参考姿势
  └ 强制根锁定: ☑  ← 关键！防止回弹
```

### Attack 目录下的动画
```
路径: RootMotion/Attack/Anim_KT3_Combo_*_RM.uasset

设置:
  ├ 启用根运动: ☑  ← 攻击需要前冲
  ├ 根运动根锁定: 参考姿势
  └ 强制根锁定: ☐
```

### Idle 目录下的动画
```
路径: RootMotion/Idle/Anim_KT3_Idle_RM.uasset

设置:
  ├ 启用根运动: ☐
  ├ 根运动根锁定: 参考姿势
  └ 强制根锁定: ☑  ← 待机不应有任何位移
```

---

## 📞 下一步

完成 Root Motion 配置后，继续完善 BlendSpace：

👉 **[返回 03b: Katana BlendSpace 制作](./03b_Katana_BlendSpace制作.md)**

👉 **[继续第四章: 动画层接口实现](./04_动画层接口实现.md)**