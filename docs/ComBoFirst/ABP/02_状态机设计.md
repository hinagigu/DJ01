# 02. 状态机设计

> **预计耗时**: 1 小时  
> **前置条件**: 已完成 01_创建主动画蓝图，已创建动画层接口（见 02a）

---

## 🎯 本章目标

设计完整的 Locomotion 状态机，支持：

1. ✅ 地面移动 (Idle / Moving)
2. ✅ 跳跃 (JumpStart / FallLoop / Land)
3. ✅ 平滑过渡
4. ✅ 根据武器类型切换动画层

---

## 🏗️ 状态机架构

```
LocomotionSM (扁平结构)
│
├── Entry ──→ Idle
│
├── Idle ←──────────────────────────────────┐
│     │                                     │
│     │ GroundSpeed > 10                    │
│     ▼                                     │
├── Moving ←───────────────────────────┐    │
│     │                                │    │
│     │ GroundSpeed <= 10              │    │
│     └────────────────→ Idle ─────────│────┘
│     │                                │
│     │ bIsFalling                     │
│     ▼                                │
├── JumpStart ←─── (Idle 也可直接跳转)  │
│     │                                │
│     │ Time Remaining <= 0.1          │
│     ▼                                │
├── FallLoop                           │
│     │                                │
│     │ GroundDistance <= 100          │
│     ▼                                │
└── Land ──────────────────────────────┘
      │
      │ !bIsFalling && Time Remaining <= 0.1
      └────────────────────→ Idle
```

---

## 📝 前置要求：创建动画层接口

> ⚠️ **重要**：Animation Layer Interface **必须使用蓝图资产创建**，不能用 C++ 定义！

详细步骤请参考：**[02a_创建动画层接口.md](./02a_创建动画层接口.md)**

需要创建的接口：
- `ALI_MeleeAnimLayers` - 近战武器动画层
- `ALI_RangedAnimLayers` - 远程武器动画层

---

## 📝 详细步骤

### Step 1: 创建状态机结构

1. **打开 ABP_DJ01Character_Base**

2. **在 AnimGraph 中创建状态机**（如果还没有）:
   - 右键 → 搜索 `State Machine`
   - 命名为 `LocomotionSM`
   - 连接到 `Output Pose`

3. **双击 LocomotionSM 进入**

4. **创建状态**:
   - 右键 → **添加状态** → `Idle`
   - 右键 → **添加状态** → `Moving`
   - 右键 → **添加状态** → `JumpStart`
   - 右键 → **添加状态** → `FallLoop`
   - 右键 → **添加状态** → `Land`

5. **创建转换连接**（拖拽状态边缘到另一个状态）:
   - `Entry` → `Idle`
   - `Idle` ↔ `Moving`（双向）
   - `Idle` → `JumpStart`
   - `Moving` → `JumpStart`
   - `JumpStart` → `FallLoop`
   - `FallLoop` → `Land`
   - `Land` → `Idle`

---

### Step 2: 使用 C++ 基类提供的变量

> ✅ **无需在蓝图中手动更新变量！**
> 
> 父类 `UDJ01AnimInstance` 在 C++ 的 `NativeUpdateAnimation` 中已实现所有物理状态更新。

#### 可直接使用的变量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `GroundSpeed` | Float | 地面移动速度 (XY平面) |
| `GroundDistance` | Float | 到地面的距离 |
| `bIsFalling` | Boolean | 是否在空中 |
| `TimeInAir` | Float | 空中持续时间 (秒) |
| `AnimLayerType` | EAnimLayerType | 当前动画层类型 (Melee/Ranged/...) |

---

### Step 3: 配置状态内部 - 使用 Blend Poses by Enum

> ⚠️ **重要**：在 AnimGraph 中不能使用 `Switch` 执行节点！
> 
> 必须使用 **`Blend Poses by Enum`** 节点来根据枚举值选择不同的 Pose。

#### 配置 Idle 状态

1. **双击 `Idle` 状态进入**

2. **右键** → 搜索 `Blend Poses by EAnimLayerType`

3. **添加 Linked Anim Layer 节点**:
   - 右键 → 搜索 `Melee Idle State` (注意：下划线会变成空格)
   - 右键 → 搜索 `Ranged Idle State`

4. **连接节点**:

```
┌──────────────────────────────────┐
│ Linked Anim Layer                │
│ ALI_MeleeAnimLayers              │
│ Melee_IdleState                  │───────┐
└──────────────────────────────────┘       │
                                           │ Melee Pose
┌──────────────────────────────────┐       │
│ Linked Anim Layer                │       ▼
│ ALI_RangedAnimLayers             │   ┌─────────────────────────────┐
│ Ranged_IdleState                 │──→│ Blend Poses (EAnimLayerType)│──→ Output
└──────────────────────────────────┘   │                             │   Animation
                                   ↑   │  • Melee Pose               │    Pose
┌──────────────────────────────────┐   │  • Ranged Pose              │
│ Anim Layer Type                  │──→│  • Active Enum Value        │
└──────────────────────────────────┘   └─────────────────────────────┘
```

5. **Blend Poses 节点配置**:
   - 右键节点 → **添加元素引脚** 为每个枚举值添加输入
   - 连接 `Anim Layer Type` 变量到 `Active Enum Value`
   - 连接对应的 Linked Anim Layer 到各个 Pose 引脚
   - `Default Pose` 可以留空（如果所有枚举值都有对应动画）

#### 配置 Moving 状态

同样的结构：

```
[Melee_MovingState]  ────→  Melee Pose  ───┐
                                           │
[Ranged_WalkState]   ────→  Ranged Pose ───┼──→ [Output Animation Pose]
                                           │
[Anim Layer Type]    ────→  Active Enum ───┘
```

#### 配置跳跃相关状态

**JumpStart**:
```
[Melee_JumpStartState]  → Melee Pose  ─┐
[Ranged_JumpStartState] → Ranged Pose ─┼→ [Blend Poses] → Output
```

**FallLoop**:
```
[Melee_FallLoopState]  → Melee Pose  ─┐
[Ranged_FallLoopState] → Ranged Pose ─┼→ [Blend Poses] → Output
```

**Land**:
```
[Melee_LandState]  → Melee Pose  ─┐
[Ranged_LandState] → Ranged Pose ─┼→ [Blend Poses] → Output
```

---

### Step 4: 配置状态转换规则

双击转换箭头配置条件：

| 转换 | 条件 |
|------|------|
| **Idle → Moving** | `GroundSpeed > 10.0` |
| **Moving → Idle** | `GroundSpeed <= 10.0` |
| **Idle → JumpStart** | `bIsFalling == true` |
| **Moving → JumpStart** | `bIsFalling == true` |
| **JumpStart → FallLoop** | `Time Remaining (ratio) <= 0.1` |
| **FallLoop → Land** | `GroundDistance <= 100.0` |
| **Land → Idle** | `!bIsFalling && Time Remaining (ratio) <= 0.1` |

#### 转换条件示例

**Idle → Moving**:
```
[Get GroundSpeed] ──→ [>] ──→ [Result]
                       │
                     10.0
```

**JumpStart → FallLoop**:
```
[Time Remaining (ratio)] ──→ [<=] ──→ [Result]
                               │
                             0.1
```

---

### Step 5: 设置转换混合

选中转换箭头，在 Details 面板设置：

| 转换 | Duration | Mode |
|------|----------|------|
| Idle ↔ Moving | 0.2s | Inertialization |
| Any → JumpStart | 0.1s | Standard Blend |
| JumpStart → FallLoop | 0.1s | Standard Blend |
| FallLoop → Land | 0.1s | Standard Blend |
| Land → Idle | 0.15s | Inertialization |

---

## 🎨 状态内部结构示意图

每个状态内部的 AnimGraph 结构：

```
┌────────────────────────────────────────────────────────────────────┐
│  状态: Idle                                                        │
│                                                                    │
│  ┌─────────────────────┐                                          │
│  │ Linked Anim Layer   │                                          │
│  │ Melee_IdleState     │──────┐                                   │
│  └─────────────────────┘      │                                   │
│                               │ Melee Pose                        │
│  ┌─────────────────────┐      │                                   │
│  │ Linked Anim Layer   │      │    ┌────────────────────────┐    │
│  │ Ranged_IdleState    │──────┼───→│ Blend Poses            │    │
│  └─────────────────────┘      │    │ (EAnimLayerType)       │    │
│                          Ranged    │                        │    │
│                          Pose │    │ Melee Pose      ●──────│    │
│  ┌─────────────────────┐      │    │ Ranged Pose     ●──────│───→│ Output
│  │ Anim Layer Type     │──────┼───→│ Active Enum Value ●    │    │ Animation
│  │ (变量)               │      │    │                        │    │ Pose
│  └─────────────────────┘      │    │ Blend Time: 0.1        │    │
│                               │    └────────────────────────┘    │
│                               │                                   │
└────────────────────────────────────────────────────────────────────┘
```

> � **提示**：
> - 不使用 `Switch on Enum` 执行节点（会报 Impure 错误）
> - 使用 `Blend Poses by Enum` 节点（专门用于 AnimGraph 的 Pose 混合）
> - `Default Pose` 引脚可以不连接（确保枚举值始终有效）

---

## 🧪 测试验证

### 测试用例

| 操作 | 预期结果 |
|------|---------|
| 站立不动 | 播放 Idle 动画（根据 AnimLayerType 选择 Melee 或 Ranged） |
| WASD 移动 | 平滑切换到 Moving |
| 停止移动 | 平滑切换回 Idle |
| 按空格跳跃 | 依次播放 JumpStart → FallLoop → Land |
| 从高处坠落 | 直接进入 FallLoop → Land |
| 切换武器类型 | 动画自动切换到对应层 |

### 调试方法

1. **打开动画调试**:
   ```
   PIE → 选择角色 → 按 ` → 输入 ShowDebug Animation
   ```

2. **查看 Blend Poses 状态**:
   - 调试视图会显示当前激活的 Pose 输入
   - 检查 `AnimLayerType` 变量值

---

## ✅ 完成检查清单

- [ ] 已创建蓝图 Animation Layer Interface（`ALI_MeleeAnimLayers`、`ALI_RangedAnimLayers`）
- [ ] 主 ABP 已实现这些接口（Class Settings → Interfaces）
- [ ] 状态机包含 5 个状态：Idle、Moving、JumpStart、FallLoop、Land
- [ ] 每个状态使用 **`Blend Poses by EAnimLayerType`** 节点（不是 Switch！）
- [ ] 每个 Blend Poses 连接了对应的 Linked Anim Layer 节点
- [ ] `Anim Layer Type` 变量连接到 `Active Enum Value`
- [ ] 转换条件正确配置
- [ ] 混合时间设置合理
- [ ] 编译无错误

---

## ⚠️ 常见问题

### Q: 搜索 Linked Anim Layer 但找不到接口函数？

**A**: 确保：
1. 已创建**蓝图 Animation Layer Interface 资产**（不是 C++ 接口）
2. 在 ABP 的 **Class Settings → Interfaces** 中添加了接口
3. 接口中已添加 Animation Layer 函数
4. 已编译保存
5. 搜索时使用空格代替下划线（如 `Melee Idle State`）

### Q: 拖拽节点显示 "Target graph does not support Impure functions"？

**A**: 这是因为你使用了 **Switch on Enum** 执行节点。

在 AnimGraph 中必须使用 **`Blend Poses by Enum`** 节点，不能使用 Switch 执行流节点。

### Q: Switch 节点的执行引脚无法连接到 Pose 引脚？

**A**: 这是不同类型的引脚：
- **执行引脚**（白色三角形）：控制代码执行流
- **Pose 引脚**（紫色人形）：传递动画姿势数据

AnimGraph 使用 Pose 数据流，不使用执行流。请改用 `Blend Poses by Enum`。

### Q: Blend Poses 节点的 Default Pose 需要连接吗？

**A**: 如果你的枚举值始终有效（代码中保证设置了正确的 AnimLayerType），可以不连接 Default Pose。

如果担心出现未处理的枚举值，可以连接一个基础 Idle 动画作为保底。

### Q: Animation Layer Interface 能用 C++ 定义吗？

**A**: **不能！** 原因：
1. `FPoseLink` 是 AnimGraph 专用类型，需要 AnimGraph 上下文
2. C++ UFUNCTION 返回 `FPoseLink` 会被标记为 "Impure"
3. 引擎只接受继承自 `UAnimLayerInterface` 的蓝图接口资产

详见：[02a_创建动画层接口.md](./02a_创建动画层接口.md)

---

## 📞 下一步

状态机设计完成！接下来我们创建 BlendSpace 让移动更流畅。

👉 **[进入第三章：BlendSpace创建](./03_BlendSpace创建.md)**