# DJ01 è¿æ‹›ç³»ç»Ÿå¼€å‘è·¯çº¿å›¾

> æœ¬æ–‡æ¡£è§„åˆ’è¿æ‹›ç³»ç»Ÿçš„å®Œæ•´å¼€å‘æµç¨‹ï¼Œç¡®ä¿æ¶æ„ç¨³å®šã€é€æ­¥æ¨è¿›ã€ä¸è¿”å·¥ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [å¼€å‘é˜¶æ®µ](#å¼€å‘é˜¶æ®µ)
3. [è¯¦ç»†ä»»åŠ¡æ¸…å•](#è¯¦ç»†ä»»åŠ¡æ¸…å•)
4. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
5. [æ¥å£å®šä¹‰](#æ¥å£å®šä¹‰)
6. [ä¾èµ–å…³ç³»](#ä¾èµ–å…³ç³»)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### ç›®æ ‡

å®ç°ä¸€ä¸ªçµæ´»çš„åŠ¨ä½œæ¸¸æˆè¿æ‹›ç³»ç»Ÿï¼Œæ”¯æŒï¼š

- âœ… æ™®æ”»è¿æ®µï¼ˆA1 â†’ A2 â†’ A3 è‡ªåŠ¨è¡”æ¥/è¾“å…¥è¡”æ¥ï¼‰
- âœ… å¤šæ®µæŠ€èƒ½ï¼ˆå¯é…ç½®çš„è¿æ‹›é“¾ï¼‰
- âœ… æŠ€èƒ½æ‰“æ–­ï¼ˆé«˜ä¼˜å…ˆçº§æŠ€èƒ½æ‰“æ–­ä½ä¼˜å…ˆçº§ï¼‰
- âœ… æ­¦å™¨åˆ‡æ¢æ‰“æ–­ï¼ˆåˆ‡æ¢æ­¦å™¨ä¸­æ–­å½“å‰åŠ¨ä½œï¼‰
- âœ… æ–¹å‘æŠ€ï¼ˆæ ¹æ®è¾“å…¥æ–¹å‘è§¦å‘ä¸åŒåˆ†æ”¯ï¼‰
- âœ… è¾“å…¥ç¼“å†²ï¼ˆé¢„è¾“å…¥æœºåˆ¶ï¼‰

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Character Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ComboManager   â”‚  â”‚  AbilitySystemComponent     â”‚   â”‚
â”‚  â”‚  - InputBuffer  â”‚â—„â”€â”¤  - æŠ€èƒ½æ¿€æ´»                  â”‚   â”‚
â”‚  â”‚  - ComboState   â”‚  â”‚  - Tagç®¡ç†                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                          â”‚                   â”‚
â”‚           â–¼                          â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AnimInstance   â”‚  â”‚  GameplayAbility            â”‚   â”‚
â”‚  â”‚  - çŠ¶æ€å˜é‡      â”‚â—„â”€â”¤  - è¿æ‹›æŠ€èƒ½                  â”‚   â”‚
â”‚  â”‚  - äº‹ä»¶é€šçŸ¥      â”‚  â”‚  - æ‰“æ–­é€»è¾‘                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AnimNotifies                                    â”‚    â”‚
â”‚  â”‚  - AN_OpenComboWindow                            â”‚    â”‚
â”‚  â”‚  - AN_CloseComboWindow                           â”‚    â”‚
â”‚  â”‚  - AN_ResetCombo                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¼€å‘é˜¶æ®µ

### Phase 0: æ¶æ„å®šä¹‰ âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ComboManager ç»„ä»¶è®¾è®¡ | âœ… | `UDJ01ComboManager` |
| InputBuffer USTRUCT | âœ… | `FDJ01ComboInputBuffer` |
| ç¼“å†²è¾“å…¥ç»“æ„ä½“ | âœ… | `FDJ01ComboBufferedInput` |

**äº§å‡ºæ–‡ä»¶ï¼š**
- `Source/DJ01/Combo/Public/DJ01ComboTypes.h`
- `Source/DJ01/Combo/Public/DJ01ComboManager.h`
- `Source/DJ01/Combo/Private/DJ01ComboTypes.cpp`
- `Source/DJ01/Combo/Private/DJ01ComboManager.cpp`

---

### Phase 1: AnimNotify æ¥å£å®šä¹‰

| ä»»åŠ¡ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| AN_DJ01_OpenComboWindow | â¬œ å¾…å¼€å‘ | P0 |
| AN_DJ01_CloseComboWindow | â¬œ å¾…å¼€å‘ | P0 |
| AN_DJ01_ResetCombo | â¬œ å¾…å¼€å‘ | P1 |
| AN_DJ01_AutoChain | â¬œ å¾…å¼€å‘ | P2 |

**ç›®æ ‡ï¼š** å®šä¹‰åŠ¨ç”»ç³»ç»Ÿä¸ ComboManager çš„äº¤äº’æ¥å£

**æ–‡ä»¶è§„åˆ’ï¼š**
```
Source/DJ01/Combo/AnimNotifies/
â”œâ”€â”€ AN_DJ01_OpenComboWindow.h
â”œâ”€â”€ AN_DJ01_OpenComboWindow.cpp
â”œâ”€â”€ AN_DJ01_CloseComboWindow.h
â”œâ”€â”€ AN_DJ01_CloseComboWindow.cpp
â”œâ”€â”€ AN_DJ01_ResetCombo.h
â””â”€â”€ AN_DJ01_ResetCombo.cpp
```

---

### Phase 2: åŠ¨ç”»ç³»ç»ŸåŸºç¡€

| ä»»åŠ¡ | çŠ¶æ€ | ä¼˜å…ˆçº§ | å‚è€ƒ |
|------|------|--------|------|
| å®Œå–„ DJ01AnimInstance | â¬œ å¾…å¼€å‘ | P0 | Lyra ALyraAnimInstance |
| åŸºç¡€ç§»åŠ¨çŠ¶æ€å˜é‡ | â¬œ å¾…å¼€å‘ | P0 | GroundDistance, Velocity ç­‰ |
| åˆ†å±‚åŠ¨ç”»æ”¯æŒ | â¬œ å¾…è¯„ä¼° | P2 | LinkedAnimLayer |
| åŠ¨ç”»è“å›¾æ¨¡æ¿ | â¬œ å¾…å¼€å‘ | P1 | ABP_Character |

**å…³é”®æš´éœ²å˜é‡ï¼š**
```cpp
// ç§»åŠ¨ç›¸å…³
float GroundDistance;
FVector Velocity;
float MovementSpeed;
bool bIsMoving;
bool bIsFalling;
bool bIsCrouching;

// æˆ˜æ–—ç›¸å…³
bool bIsInCombat;
int32 CurrentComboIndex;
bool bComboWindowOpen;
```

---

### Phase 3: æŠ€èƒ½ç³»ç»Ÿé›†æˆ

| ä»»åŠ¡ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| è¿æ‹›æŠ€èƒ½åŸºç±»è®¾è®¡ | â¬œ å¾…å¼€å‘ | P0 |
| æŠ€èƒ½â†’ComboManager äº¤äº’ | â¬œ å¾…å¼€å‘ | P0 |
| æŠ€èƒ½æ‰“æ–­è§„åˆ™é…ç½® | â¬œ å¾…å¼€å‘ | P1 |
| AbilityTask_WaitComboInput | â¬œ å¾…è¯„ä¼° | P2 |

**æŠ€èƒ½åŸºç±»éœ€è¦çš„åŠŸèƒ½ï¼š**
```cpp
// UDJ01ComboAbility : UDJ01GameplayAbility
class UDJ01ComboAbility
{
    // è¿æ‹›é“¾æ ‡è¯†
    FGameplayTag ComboChainTag;
    
    // å½“å‰æ˜¯ç¬¬å‡ æ®µ
    int32 ComboIndex;
    
    // å¯è¢«å“ªäº›æŠ€èƒ½æ‰“æ–­
    FGameplayTagContainer CancelledByTags;
    
    // ä¸‹ä¸€æ®µæŠ€èƒ½å€™é€‰
    TArray<FGameplayTag> NextComboOptions;
};
```

---

### Phase 4: æ™®æ”»åŸå‹éªŒè¯

| ä»»åŠ¡ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ™®æ”»åŠ¨ç”»èµ„æº | â¬œ å¾…å‡†å¤‡ | P0 |
| æ™®æ”» Montage + Notify | â¬œ å¾…å¼€å‘ | P0 |
| æ™®æ”»æŠ€èƒ½ GA_Attack | â¬œ å¾…å¼€å‘ | P0 |
| å®Œæ•´æµç¨‹æµ‹è¯• | â¬œ å¾…æµ‹è¯• | P0 |

**éªŒè¯æµç¨‹ï¼š**
```
ç©å®¶æŒ‰é”® â†’ ComboManager.BufferInput() 
    â†’ ASC.TryActivateAbility()
    â†’ GA_Attack.Activate()
    â†’ PlayMontage(Attack_01)
    â†’ AN_OpenComboWindow â†’ ComboManager.OpenComboWindow()
    â†’ ç©å®¶å†æ¬¡æŒ‰é”® â†’ BufferInput() è¢«ç¼“å†²
    â†’ AN_CloseComboWindow â†’ ComboManager.CloseComboWindowAndConsume()
    â†’ æ¶ˆè´¹æˆåŠŸ â†’ æ¿€æ´» Attack_02
    â†’ å¾ªç¯...
```

---

### Phase 5: è¿æ‹›ç³»ç»Ÿå®Œå–„

| ä»»åŠ¡ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| å¤šæ­¦å™¨è¿æ‹›é“¾ | â¬œ å¾…å¼€å‘ | P1 |
| æ–¹å‘æŠ€åˆ†æ”¯ | â¬œ å¾…å¼€å‘ | P1 |
| æŠ€èƒ½æ‰“æ–­éªŒè¯ | â¬œ å¾…å¼€å‘ | P1 |
| æ­¦å™¨åˆ‡æ¢æ‰“æ–­ | â¬œ å¾…å¼€å‘ | P2 |
| è‡ªåŠ¨è¡”æ¥ï¼ˆéƒ¨åˆ†è¿æ®µï¼‰ | â¬œ å¾…å¼€å‘ | P2 |

---

### Phase 6: é…ç½®åŒ–ä¸å·¥å…·

| ä»»åŠ¡ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| ComboData æ•°æ®èµ„äº§ | â¬œ å¾…è¯„ä¼° | P2 |
| è¿æ‹›å¯è§†åŒ–ç¼–è¾‘å™¨ | â¬œ å¾…è¯„ä¼° | P3 |
| è°ƒè¯•å·¥å…· | â¬œ å¾…å¼€å‘ | P2 |

---

## è¯¦ç»†ä»»åŠ¡æ¸…å•

### å½“å‰ Sprint: Phase 1 - AnimNotify

```
[ ] åˆ›å»º AnimNotifies ç›®å½•
[ ] å®ç° AN_DJ01_OpenComboWindow
    [ ] .h æ–‡ä»¶
    [ ] .cpp æ–‡ä»¶
    [ ] æµ‹è¯•ç¼–è¯‘
[ ] å®ç° AN_DJ01_CloseComboWindow
    [ ] .h æ–‡ä»¶
    [ ] .cpp æ–‡ä»¶
    [ ] æµ‹è¯•ç¼–è¯‘
[ ] å®ç° AN_DJ01_ResetCombo
    [ ] .h æ–‡ä»¶
    [ ] .cpp æ–‡ä»¶
    [ ] æµ‹è¯•ç¼–è¯‘
```

---

## æ¶æ„è®¾è®¡

### æ•°æ®æµ

```mermaid
sequenceDiagram
    participant Input as ç©å®¶è¾“å…¥
    participant CM as ComboManager
    participant ASC as AbilitySystem
    participant Ability as è¿æ‹›æŠ€èƒ½
    participant Anim as åŠ¨ç”»ç³»ç»Ÿ
    participant Notify as AnimNotify

    Input->>CM: BufferInput(AttackTag)
    CM->>ASC: TryActivateAbilityByTag()
    ASC->>Ability: ActivateAbility()
    Ability->>Anim: PlayMontage()
    
    Note over Anim: åŠ¨ç”»æ’­æ”¾ä¸­...
    
    Anim->>Notify: è§¦å‘ OpenComboWindow
    Notify->>CM: OpenComboWindow()
    
    Input->>CM: BufferInput(AttackTag) [ç¼“å†²]
    
    Anim->>Notify: è§¦å‘ CloseComboWindow
    Notify->>CM: CloseComboWindowAndConsume()
    CM->>ASC: TryActivateAbilityByTag(ä¸‹ä¸€æ®µ)
```

### ç±»å›¾

```mermaid
classDiagram
    class UDJ01ComboManager {
        -FDJ01ComboInputBuffer InputBuffer
        -bool bComboWindowOpen
        -FGameplayTag CurrentComboChainTag
        -int32 CurrentComboIndex
        +BufferInput(Tag, Priority)
        +OpenComboWindow(ChainTag)
        +CloseComboWindowAndConsume() bool
        +ResetComboState()
    }
    
    class FDJ01ComboInputBuffer {
        -TArray~FDJ01ComboBufferedInput~ RingBuffer
        -int32 WriteIndex
        +BufferInput(Tag, Priority, Time, ComboIndex)
        +ConsumeAndClear(Time, OutInput) bool
        +HasAnyInput(Time) bool
        +Clear()
    }
    
    class UAN_DJ01_OpenComboWindow {
        +FGameplayTag ComboChainTag
        +Notify(MeshComp, Animation)
    }
    
    class UAN_DJ01_CloseComboWindow {
        +bool bConsumeInput
        +Notify(MeshComp, Animation)
    }
    
    class UDJ01ComboAbility {
        +FGameplayTag ComboChainTag
        +int32 ComboIndex
        +TArray~FGameplayTag~ NextComboOptions
        +ActivateAbility()
        +OnMontageEnded()
    }
    
    UDJ01ComboManager *-- FDJ01ComboInputBuffer
    UAN_DJ01_OpenComboWindow --> UDJ01ComboManager : calls
    UAN_DJ01_CloseComboWindow --> UDJ01ComboManager : calls
    UDJ01ComboAbility --> UDJ01ComboManager : uses
```

---

## æ¥å£å®šä¹‰

### ComboManager å…¬å¼€æ¥å£

```cpp
// è¾“å…¥ç¼“å†²
void BufferInput(FGameplayTag AbilityTag, int32 Priority = 50);
bool TryActivateOrBuffer(FGameplayTag AbilityTag, int32 Priority = 50);
bool HasBufferedInput() const;
void ClearInputBuffer();

// è¿æ‹›çª—å£ï¼ˆAnimNotify è°ƒç”¨ï¼‰
void OpenComboWindow(FGameplayTag ComboChainTag = FGameplayTag());
bool CloseComboWindowAndConsume();
void CloseComboWindow();
bool IsComboWindowOpen() const;

// è¿æ‹›çŠ¶æ€
int32 GetCurrentComboIndex() const;
FGameplayTag GetCurrentComboChainTag() const;
void AdvanceComboIndex();
void ResetComboState();

// è‡ªåŠ¨è¡”æ¥
void RequestAutoChain(FGameplayTag NextAbilityTag);

// äº‹ä»¶å§”æ‰˜
FOnComboWindowStateChanged OnComboWindowStateChanged;
FOnComboAdvanced OnComboAdvanced;
```

### AnimNotify æ¥å£

```cpp
// AN_DJ01_OpenComboWindow
UPROPERTY(EditAnywhere)
FGameplayTag ComboChainTag;  // å¯é€‰ï¼Œæ ‡è¯†å½“å‰è¿æ‹›é“¾

// AN_DJ01_CloseComboWindow
UPROPERTY(EditAnywhere)
bool bConsumeInput = true;  // æ˜¯å¦æ¶ˆè´¹è¾“å…¥

// AN_DJ01_ResetCombo
// æ— é¢å¤–å‚æ•°ï¼Œç›´æ¥è°ƒç”¨ ResetComboState()
```

---

## ä¾èµ–å…³ç³»

```
Phase 0 (æ¶æ„) â”€â”€â”¬â”€â”€ Phase 1 (AnimNotify)
                 â”‚
                 â””â”€â”€ Phase 2 (åŠ¨ç”»ç³»ç»Ÿ) â”€â”€â”¬â”€â”€ Phase 3 (æŠ€èƒ½ç³»ç»Ÿ)
                                          â”‚
                                          â””â”€â”€ Phase 4 (æ™®æ”»éªŒè¯)
                                                      â”‚
                                                      â–¼
                                               Phase 5 (å®Œå–„)
                                                      â”‚
                                                      â–¼
                                               Phase 6 (å·¥å…·)
```

**å…³é”®ä¾èµ–ï¼š**
- Phase 1, 2, 3 å¯ä»¥**å¹¶è¡Œå¼€å‘**ï¼Œå®ƒä»¬åªä¾èµ– Phase 0
- Phase 4 éœ€è¦ 1, 2, 3 å…¨éƒ¨å®Œæˆåæ‰èƒ½éªŒè¯
- Phase 5, 6 æ˜¯è¿­ä»£ä¼˜åŒ–é˜¶æ®µ

---

## å‚è€ƒèµ„æ–™

- [Lyra åŠ¨ç”»ç³»ç»Ÿ](../Source/DJ01/Character/README.md)
- [GAS æ¶æ„æ–‡æ¡£](../Source/DJ01/AbilitySystem/AbilitySystem_Architecture.md)
- [åŠ¨ç”»ç³»ç»Ÿè®¾è®¡](./Now/AnimationSystem_Design.md)

---

## æ›´æ–°è®°å½•

| æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|----------|
| 2025-12-07 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆ Phase 0 æ¶æ„å®šä¹‰ |