# 06 - è¿›ç¨‹é—´é€šä¿¡è®¾è®¡

## ğŸ¯ é—®é¢˜èƒŒæ™¯

DataAssetManager å·¥å…·éœ€è¦è§£å†³ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Python GUI     â”‚  â”€â”€â”€â”€ å¦‚ä½•é€šä¿¡ â”€â”€â”€â”€ â”‚  Unreal Engine  â”‚
â”‚  (ç‹¬ç«‹è¿›ç¨‹)     â”‚                    â”‚  (ç‹¬ç«‹è¿›ç¨‹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¸¤ä¸ªç‹¬ç«‹è¿›ç¨‹ä¹‹é—´å¦‚ä½•äº¤æ¢æ•°æ®ï¼Ÿ

---

## ğŸ“ å¸¸è§çš„ IPC æ–¹å¼

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **æ–‡ä»¶ç›‘æ§** | ç®€å•å¯é ã€è·¨å¹³å° | æœ‰è½®è¯¢å»¶è¿Ÿ | ä½é¢‘é€šä¿¡ |
| **Socket (TCP/UDP)** | å®æ—¶æ€§å¥½ | éœ€å¤„ç†ç½‘ç»œå¤æ‚æ€§ | é«˜é¢‘é€šä¿¡ |
| **å…±äº«å†…å­˜** | æœ€å¿« | å®ç°å¤æ‚ã€éœ€åŒæ­¥ | å¤§æ•°æ®é‡ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | è§£è€¦ã€å¯é  | éœ€è¦ä¸­é—´ä»¶ | åˆ†å¸ƒå¼ç³»ç»Ÿ |
| **å‘½åç®¡é“** | ç³»ç»ŸåŸç”Ÿæ”¯æŒ | å¹³å°å·®å¼‚å¤§ | åŒæœºé€šä¿¡ |

---

## ğŸ”§ é¡¹ç›®é‡‡ç”¨çš„æ–¹æ¡ˆï¼šæ–‡ä»¶ç›‘æ§

### ä¸ºä»€ä¹ˆé€‰æ‹©æ–‡ä»¶ç›‘æ§ï¼Ÿ

1. **UE é™åˆ¶**ï¼šUE çš„è¿œç¨‹æ‰§è¡Œä½¿ç”¨ UDP ç»„æ’­åè®®ï¼Œå®ç°å¤æ‚
2. **ç®€å•å¯é **ï¼šæ–‡ä»¶æ“ä½œæ˜¯æœ€åŸºç¡€çš„ OS åŠŸèƒ½
3. **å¯è°ƒè¯•**ï¼šå¯ä»¥ç›´æ¥æŸ¥çœ‹ä¸­é—´æ–‡ä»¶å†…å®¹
4. **æ— ä¾èµ–**ï¼šä¸éœ€è¦é¢å¤–çš„åº“æˆ–æœåŠ¡

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Python GUI    â”‚                         â”‚  Unreal Engine  â”‚
â”‚                 â”‚                         â”‚                 â”‚
â”‚  UERemoteExecutor                         â”‚  CommandMonitor â”‚
â”‚       â”‚         â”‚                         â”‚       â”‚         â”‚
â”‚       â–¼         â”‚                         â”‚       â”‚         â”‚
â”‚  å†™å…¥å‘½ä»¤æ–‡ä»¶   â”‚                         â”‚  è½®è¯¢æ£€æŸ¥æ–‡ä»¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                           â”‚
        â–¼                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ–‡ä»¶ç³»ç»Ÿ                              â”‚
â”‚  Intermediate/DataAssetManager/                             â”‚
â”‚  â”œâ”€â”€ pending_command.json   â† å‘½ä»¤è¯·æ±‚                       â”‚
â”‚  â”œâ”€â”€ command_result.json    â† æ‰§è¡Œç»“æœ                       â”‚
â”‚  â””â”€â”€ ue_heartbeat.txt       â† å¿ƒè·³æ–‡ä»¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®å®ç°

### 1. å‘½ä»¤æ–‡ä»¶æ ¼å¼

```json
// pending_command.json
{
    "type": "execute_file",
    "script_path": "D:/Project/Tools/ue_scripts/generate_experience.py",
    "timestamp": "2024-12-23T18:30:00",
    "command_id": "cmd_001"
}
```

### 2. ç»“æœæ–‡ä»¶æ ¼å¼

```json
// command_result.json
{
    "command_id": "cmd_001",
    "success": true,
    "message": "ç”ŸæˆæˆåŠŸ",
    "timestamp": "2024-12-23T18:30:01"
}
```

### 3. Python GUI ç«¯ (å†™å…¥å‘½ä»¤ã€ç­‰å¾…ç»“æœ)

```python
# core/ue_remote.py
class UERemoteExecutor:
    def execute_file(self, script_path: str, timeout: float = 30.0):
        # 1. æ¸…ç†æ—§çš„ç»“æœæ–‡ä»¶
        if os.path.exists(self.result_file):
            os.remove(self.result_file)
        
        # 2. å†™å…¥å‘½ä»¤æ–‡ä»¶
        command = {
            "type": "execute_file",
            "script_path": script_path,
            "timestamp": datetime.now().isoformat()
        }
        with open(self.cmd_file, 'w', encoding='utf-8') as f:
            json.dump(command, f)
        
        # 3. è½®è¯¢ç­‰å¾…ç»“æœ
        start_time = time.time()
        while time.time() - start_time < timeout:
            if os.path.exists(self.result_file):
                with open(self.result_file, 'r') as f:
                    result = json.load(f)
                return result['success'], result['message']
            time.sleep(0.1)  # 100ms è½®è¯¢é—´éš”
        
        return False, "æ‰§è¡Œè¶…æ—¶"
```

### 4. UE ç«¯ (ç›‘æ§å‘½ä»¤ã€æ‰§è¡Œè„šæœ¬)

```python
# ue_scripts/command_monitor.py
import unreal

class CommandMonitor:
    def __init__(self):
        self.cmd_file = "Intermediate/DataAssetManager/pending_command.json"
        self.result_file = "Intermediate/DataAssetManager/command_result.json"
        
    def tick(self, delta_time):
        """æ¯å¸§è°ƒç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†å‘½ä»¤"""
        if os.path.exists(self.cmd_file):
            self._process_command()
    
    def _process_command(self):
        # 1. è¯»å–å¹¶åˆ é™¤å‘½ä»¤æ–‡ä»¶
        with open(self.cmd_file, 'r') as f:
            cmd = json.load(f)
        os.remove(self.cmd_file)
        
        # 2. æ‰§è¡Œè„šæœ¬
        try:
            script_path = cmd['script_path']
            with open(script_path, 'r') as f:
                code = f.read()
            exec(code, {'__file__': script_path})
            result = {"success": True, "message": "æ‰§è¡ŒæˆåŠŸ"}
        except Exception as e:
            result = {"success": False, "message": str(e)}
        
        # 3. å†™å…¥ç»“æœæ–‡ä»¶
        with open(self.result_file, 'w') as f:
            json.dump(result, f)

# æ³¨å†Œ tick å›è°ƒ
monitor = CommandMonitor()
unreal.register_slate_post_tick_callback(monitor.tick)
```

---

## â¤ï¸ å¿ƒè·³æœºåˆ¶

### ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ï¼Ÿ

GUI éœ€è¦çŸ¥é“ UE æ˜¯å¦åœ¨è¿è¡Œï¼Œå¦åˆ™å‘é€å‘½ä»¤æ²¡æœ‰æ„ä¹‰ã€‚

### å®ç°æ–¹å¼

```python
# UE ç«¯ï¼šå®šæœŸæ›´æ–°å¿ƒè·³æ–‡ä»¶
def tick(self, delta_time):
    self._update_heartbeat()
    
def _update_heartbeat(self):
    with open(self.heartbeat_file, 'w') as f:
        f.write(str(time.time()))

# GUI ç«¯ï¼šæ£€æŸ¥å¿ƒè·³æ–‡ä»¶æ—¶é—´
def is_ue_running(self) -> bool:
    if not os.path.exists(self.heartbeat_file):
        return False
    
    mtime = os.path.getmtime(self.heartbeat_file)
    age = time.time() - mtime
    return age < 10  # 10 ç§’å†…æ›´æ–°è¿‡åˆ™è®¤ä¸ºåœ¨çº¿
```

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. åŸå­æ€§è€ƒè™‘

```python
# å†™å…¥æ—¶ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…è¯»å–åˆ°ä¸å®Œæ•´æ•°æ®
temp_file = self.cmd_file + '.tmp'
with open(temp_file, 'w') as f:
    json.dump(command, f)
os.rename(temp_file, self.cmd_file)  # åŸå­æ“ä½œ
```

### 2. è¶…æ—¶å¤„ç†

```python
start_time = time.time()
while time.time() - start_time < timeout:
    # è½®è¯¢...
    time.sleep(0.1)
return False, "æ‰§è¡Œè¶…æ—¶"
```

### 3. é”™è¯¯æ¢å¤

```python
# å¯åŠ¨æ—¶æ¸…ç†æ®‹ç•™æ–‡ä»¶
if os.path.exists(self.cmd_file):
    os.remove(self.cmd_file)
if os.path.exists(self.result_file):
    os.remove(self.result_file)
```

---

## ğŸ“Š ä¼˜ç¼ºç‚¹åˆ†æ

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| å®ç°ç®€å• | è½®è¯¢æœ‰å»¶è¿Ÿ (100ms~) |
| è·¨å¹³å° | ä¾èµ–æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ |
| å¯è°ƒè¯• | ä¸é€‚åˆé«˜é¢‘é€šä¿¡ |
| æ— ç½‘ç»œé…ç½® | åŒä¸€å°æœºå™¨é™åˆ¶ |

---

## ğŸ”„ å¯èƒ½çš„æ”¹è¿›

1. **ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘å¬** (watchdog åº“) æ›¿ä»£è½®è¯¢
2. **æ·»åŠ å‘½ä»¤é˜Ÿåˆ—** æ”¯æŒå¤šä¸ªå¾…å¤„ç†å‘½ä»¤
3. **æ”¯æŒåŒå‘é€šä¿¡** UE ä¸»åŠ¨é€šçŸ¥ GUI