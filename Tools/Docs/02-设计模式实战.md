# 02 - è®¾è®¡æ¨¡å¼å®æˆ˜

## ğŸ¯ ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼ï¼Ÿ

è®¾è®¡æ¨¡å¼æ˜¯å‰äººæ€»ç»“çš„**è§£å†³ç‰¹å®šé—®é¢˜çš„é€šç”¨æ–¹æ¡ˆ**ã€‚ä¸æ˜¯å¿…é¡»ç”¨ï¼Œä½†ç”¨å¯¹äº†èƒ½è®©ä»£ç æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤ã€‚

---

## ğŸ­ å·¥å‚æ¨¡å¼ (Factory Pattern)

### é—®é¢˜åœºæ™¯
æ ¹æ®é…ç½®åˆ›å»ºä¸åŒç±»å‹çš„ UI æ§ä»¶ï¼Œå¦‚æœç”¨ `if-else` æ•£è½å„å¤„ï¼š

```python
# âŒ æ•£è½åœ¨å„å¤„çš„åˆ›å»ºé€»è¾‘
if widget_type == "text":
    widget = TextInput(parent)
elif widget_type == "combo":
    widget = ComboBox(parent)
# æ¯ä¸ªåœ°æ–¹éƒ½è¦å†™ä¸€é...
```

### è§£å†³æ–¹æ¡ˆ
é›†ä¸­åˆ°ä¸€ä¸ª"å·¥å‚"ç±»ï¼š

```python
# âœ“ ui/widgets/factory.py
class WidgetFactory:
    def create(self, parent, prop_config):
        widget_type = prop_config.widget
        
        if widget_type == "text_input":
            return TextInputWidget(parent, prop_config)
        elif widget_type == "combobox":
            return ComboBoxWidget(parent, prop_config, self._get_options)
        elif widget_type == "checkbox_list":
            return CheckboxListWidget(parent, prop_config)
        elif widget_type == "instanced_array_editor":
            return InstancedArrayEditorWidget(parent, prop_config)
        else:
            return TextInputWidget(parent, prop_config)  # é»˜è®¤
```

### å…³é”®è¦ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      create()      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WidgetFactory â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  PropertyWidget â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â–³
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚                         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ TextInputWidgetâ”‚         â”‚ ComboBoxWidget â”‚         â”‚CheckboxListWidgetâ”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰æ§ä»¶åˆ›å»ºéƒ½é€šè¿‡ `factory.create()`
- **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°æ§ä»¶åªéœ€åŠ ä¸€ä¸ª `elif`
- **è°ƒç”¨æ–¹æ— æ„ŸçŸ¥**ï¼šä½¿ç”¨è€…åªå…³å¿ƒæ¥å£ï¼Œä¸å…³å¿ƒå…·ä½“å®ç°

---

## ğŸ‘€ è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

### é—®é¢˜åœºæ™¯
æ§ä»¶å€¼å˜åŒ–æ—¶ï¼Œéœ€è¦é€šçŸ¥å¤šä¸ªåœ°æ–¹æ›´æ–°ï¼š

```python
# âŒ æ§ä»¶ç›´æ¥è°ƒç”¨å¤–éƒ¨é€»è¾‘ï¼Œè€¦åˆä¸¥é‡
class TextInput:
    def on_change(self, value):
        self.editor.data[self.name] = value  # ç›´æ¥æ“ä½œç¼–è¾‘å™¨
        self.editor.mark_dirty()              # ç´§è€¦åˆ
        self.status_bar.update()              # è¿˜è¦çŸ¥é“çŠ¶æ€æ 
```

### è§£å†³æ–¹æ¡ˆ
æ§ä»¶åªè´Ÿè´£"é€šçŸ¥"ï¼Œä¸å…³å¿ƒè°åœ¨å¬ï¼š

```python
# âœ“ æ§ä»¶åªè§¦å‘å›è°ƒ
class TextInputWidget:
    def __init__(self, parent, prop, on_change=None):
        self.on_change = on_change  # ä¿å­˜å›è°ƒå‡½æ•°
        
    def _value_changed(self, *args):
        if self.on_change:
            self.on_change(self.prop.name, self.get_value())  # é€šçŸ¥

# âœ“ ç¼–è¾‘å™¨è®¢é˜…å˜åŒ–
class BaseEditor:
    def create_widget(self, prop):
        widget = self.factory.create(
            parent=self.frame,
            prop=prop,
            on_change=self.on_property_changed  # ä¼ å…¥å›è°ƒ
        )
    
    def on_property_changed(self, prop_name, new_value):
        self.current_data[prop_name] = new_value
        self.mark_dirty()
```

### å…³é”®è¦ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  on_change(name, value)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Widget    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚   Editor    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                         â”‚
      â”‚ ä¸çŸ¥é“è°åœ¨ç›‘å¬                            â”‚ ä¸çŸ¥é“é€šçŸ¥ä»å“ªæ¥
      â”‚ åªè´Ÿè´£"å–Šä¸€å£°"                            â”‚ åªè´Ÿè´£"å¤„ç†"
```

- **è§£è€¦**ï¼šæ§ä»¶ä¸ä¾èµ–ç¼–è¾‘å™¨çš„å…·ä½“å®ç°
- **çµæ´»**ï¼šåŒä¸€ä¸ªæ§ä»¶å¯ä»¥è¢«ä¸åŒçš„ç›‘å¬è€…ä½¿ç”¨
- **å¯æµ‹è¯•**ï¼šå¯ä»¥ä¼ å…¥ mock å›è°ƒå‡½æ•°è¿›è¡Œæµ‹è¯•

---

## ğŸ“‹ æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method)

### é—®é¢˜åœºæ™¯
å¤šä¸ªç¼–è¾‘å™¨æœ‰ç›¸ä¼¼çš„æµç¨‹ï¼Œä½†ç»†èŠ‚ä¸åŒï¼š

```python
# âŒ æ¯ä¸ªç¼–è¾‘å™¨éƒ½è¦å†™ä¸€éç›¸ä¼¼çš„ä»£ç 
class ExperienceEditor:
    def __init__(self):
        self.bind('<Control-s>', self.save)
        self.bind('<F2>', self.rename)
        # é‡å¤...

class PawnDataEditor:
    def __init__(self):
        self.bind('<Control-s>', self.save)  # åˆå†™ä¸€é
        self.bind('<F2>', self.rename)       # åˆå†™ä¸€é
```

### è§£å†³æ–¹æ¡ˆ
åŸºç±»å®šä¹‰"éª¨æ¶"ï¼Œå­ç±»å¡«å……"ç»†èŠ‚"ï¼š

```python
# âœ“ åŸºç±»å®šä¹‰é€šç”¨æµç¨‹
class BaseEditorUI(ABC):
    def __init__(self, parent):
        self._bind_shortcuts()  # é€šç”¨å¿«æ·é”®
        self.setup_ui()         # è°ƒç”¨å­ç±»å®ç°
    
    def _bind_shortcuts(self):
        """æ‰€æœ‰ç¼–è¾‘å™¨å…±äº«çš„å¿«æ·é”®"""
        self.parent.bind('<Control-s>', self._on_save)
        self.parent.bind('<F2>', self._on_rename)
    
    @abstractmethod
    def load_data(self):
        """å­ç±»å¿…é¡»å®ç°ï¼šåŠ è½½æ•°æ®"""
        pass
    
    @abstractmethod
    def save_data(self):
        """å­ç±»å¿…é¡»å®ç°ï¼šä¿å­˜æ•°æ®"""
        pass

# âœ“ å­ç±»åªå…³å¿ƒè‡ªå·±çš„ç‰¹æ®Šé€»è¾‘
class ExperienceEditor(BaseEditorUI):
    def load_data(self):
        return self.manager.load_experiences()
    
    def save_data(self):
        self.manager.save_experience(self.current)
```

### å…³é”®è¦ç‚¹

```
         BaseEditorUI (æŠ½è±¡åŸºç±»)
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ _bind_shortcuts()   â”‚  â† å®ç°ï¼šé€šç”¨å¿«æ·é”®
         â”‚ setup_ui()          â”‚  â† å®ç°ï¼šåŸºç¡€ UI
         â”‚ load_data()         â”‚  â† æŠ½è±¡ï¼šå­ç±»å®ç°
         â”‚ save_data()         â”‚  â† æŠ½è±¡ï¼šå­ç±»å®ç°
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–³
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ExperienceEditor â”‚  â”‚PawnDataEditor â”‚
â”‚  load_data()     â”‚  â”‚  load_data()  â”‚
â”‚  save_data()     â”‚  â”‚  save_data()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ä»£ç å¤ç”¨**ï¼šé€šç”¨é€»è¾‘å†™ä¸€æ¬¡
- **å¼ºåˆ¶å¥‘çº¦**ï¼š`@abstractmethod` ç¡®ä¿å­ç±»ä¸ä¼šå¿˜è®°å®ç°
- **å¼€é—­åŸåˆ™**ï¼šæ·»åŠ æ–°ç¼–è¾‘å™¨åªéœ€ç»§æ‰¿ï¼Œæ— éœ€æ”¹åŸºç±»

---

## ğŸ”§ å•ä¾‹æ¨¡å¼ (Singleton) - è°¨æ…ä½¿ç”¨

### é—®é¢˜åœºæ™¯
æŸäº›èµ„æºå…¨å±€åªéœ€è¦ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚é…ç½®ç®¡ç†å™¨ã€æ•°æ®åº“è¿æ¥ã€‚

### é¡¹ç›®ä¸­çš„åº”ç”¨

```python
# core/options_scanner.py - å®é™…ä¸Šé€šè¿‡å‚æ•°ä¼ é€’å®ç°ç±»ä¼¼æ•ˆæœ
class OptionsScanner:
    _instance = None
    
    @classmethod
    def get_instance(cls, project_root=None):
        if cls._instance is None:
            cls._instance = cls(project_root)
        return cls._instance
```

### å…³é”®è¦ç‚¹

âš ï¸ **è°¨æ…ä½¿ç”¨å•ä¾‹**ï¼Œå› ä¸ºï¼š
- éšè—ä¾èµ–å…³ç³»
- éš¾ä»¥æµ‹è¯•
- å¤šçº¿ç¨‹ç¯å¢ƒå®¹æ˜“å‡ºé—®é¢˜

**æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ**ï¼šä¾èµ–æ³¨å…¥ + åœ¨åº”ç”¨å…¥å£åˆ›å»ºå®ä¾‹

```python
# main.py - åœ¨å…¥å£ç»Ÿä¸€åˆ›å»ºå¹¶ä¼ é€’
scanner = OptionsScanner(project_root)
editor = ExperienceEditor(scanner=scanner)  # æ³¨å…¥ä¾èµ–
```

---

## ğŸ“Š æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨

| åœºæ™¯ | æ¨èæ¨¡å¼ |
|------|---------|
| æ ¹æ®ç±»å‹åˆ›å»ºä¸åŒå¯¹è±¡ | å·¥å‚æ¨¡å¼ |
| å¯¹è±¡å˜åŒ–éœ€è¦é€šçŸ¥å¤šæ–¹ | è§‚å¯Ÿè€…æ¨¡å¼ |
| å¤šä¸ªç±»æœ‰ç›¸ä¼¼æµç¨‹ | æ¨¡æ¿æ–¹æ³•æ¨¡å¼ |
| å…¨å±€å”¯ä¸€èµ„æº | å•ä¾‹ï¼ˆæˆ–ä¾èµ–æ³¨å…¥ï¼‰ |
| ä¸ºå¯¹è±¡åŠ¨æ€æ·»åŠ åŠŸèƒ½ | è£…é¥°å™¨æ¨¡å¼ |
| ç®€åŒ–å¤æ‚å­ç³»ç»Ÿçš„æ¥å£ | å¤–è§‚æ¨¡å¼ |