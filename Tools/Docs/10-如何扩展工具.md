# 10 - å¦‚ä½•æ‰©å±•å·¥å…·

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ˜¯å®è·µæŒ‡å—ï¼Œæ•™ä½ å¦‚ä½•åœ¨ä¸æ·±å…¥ç†è§£æ‰€æœ‰ä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¿®æ”¹é…ç½®å’Œå°‘é‡ä»£ç æ¥æ‰©å±• DataAssetManager å·¥å…·ã€‚

---

## ğŸ“‹ å¸¸è§æ‰©å±•åœºæ™¯

| åœºæ™¯ | éœ€è¦ä¿®æ”¹ | éš¾åº¦ |
|------|---------|------|
| æ·»åŠ æ–°çš„æ‰«æè·¯å¾„ | `scan_paths.json` | â­ |
| æ·»åŠ æ–°çš„èµ„äº§ç±»å‹ | `schema/*.json` | â­â­ |
| æ·»åŠ æ–°çš„å±æ€§æ§ä»¶ | `schema/*.json` + `_common.json` | â­â­ |
| æ·»åŠ æ–°çš„æ§ä»¶ç±»å‹ | `ui/widgets/*.py` + `factory.py` | â­â­â­ |
| ä¿®æ”¹ UE èµ„äº§ç”Ÿæˆé€»è¾‘ | `ue_scripts/*.py` | â­â­â­ |

---

## â­ åœºæ™¯1ï¼šæ·»åŠ æ–°çš„æ‰«æè·¯å¾„

### éœ€æ±‚
ä½ åˆ›å»ºäº†æ–°çš„æŠ€èƒ½è“å›¾ç›®å½• `Content/Gameplay/Abilities/Special`ï¼Œå¸Œæœ›å·¥å…·èƒ½æ‰«æåˆ°ã€‚

### æ­¥éª¤

1. æ‰“å¼€ `Tools/DataAssetManager/configs/scan_paths.json`

2. æ‰¾åˆ° `gameplay_abilities` é…ç½®ï¼Œæ·»åŠ æ–°è·¯å¾„ï¼š

```json
"gameplay_abilities": {
  "description": "Gameplay æŠ€èƒ½ç±»æ‰«æé…ç½®ï¼ˆé€’å½’æ‰«æï¼‰",
  "cpp_paths": [
    "Source/DJ01/AbilitySystem/Abilities"
  ],
  "blueprint_paths": [
    "Content/Gameplay/Abilities/GA_Blueprints",
    "Content/Gameplay/Abilities/Special"  // â† æ·»åŠ è¿™è¡Œ
  ],
  "prefixes": ["GA_", "Ability_", "Special_"]  // â† å¯é€‰ï¼šæ·»åŠ å‰ç¼€
}
```

3. é‡å¯å·¥å…·å³å¯

### åŸç†
`options_scanner.py` ä¼šè¯»å–è¿™ä¸ªé…ç½®ï¼Œé€’å½’æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„ `.uasset` æ–‡ä»¶ã€‚

---

## â­â­ åœºæ™¯2ï¼šæ·»åŠ æ–°çš„èµ„äº§ç±»å‹

### éœ€æ±‚
ä½ æƒ³ç”¨å·¥å…·ç®¡ç†ä¸€ä¸ªæ–°çš„ DataAsset ç±»å‹ï¼Œæ¯”å¦‚ `UMyWeaponData`ã€‚

### æ­¥éª¤

1. **åˆ›å»º Schema æ–‡ä»¶** `configs/schema/weapon_data.json`ï¼š

```json
{
  "WeaponData": {
    "class_name": "UMyWeaponData",
    "parent_class": "UPrimaryDataAsset",
    "asset_type": "DataAsset",
    "display_name": "æ­¦å™¨æ•°æ®",
    "description": "å®šä¹‰æ­¦å™¨çš„å±æ€§",
    "content_path": "/Game/Weapons/Data",
    "icon": "ğŸ—¡ï¸",
    
    "properties": {
      "WeaponName": {
        "type": "FString",
        "display_name": "æ­¦å™¨åç§°",
        "widget": "text_input",
        "required": true
      },
      "Damage": {
        "type": "float",
        "display_name": "ä¼¤å®³å€¼",
        "widget": "spinbox",
        "default": 10.0,
        "min": 0,
        "max": 1000
      },
      "WeaponType": {
        "type": "EWeaponType",
        "display_name": "æ­¦å™¨ç±»å‹",
        "widget": "combobox",
        "options": [
          {"name": "Melee", "display_name": "è¿‘æˆ˜"},
          {"name": "Ranged", "display_name": "è¿œç¨‹"},
          {"name": "Magic", "display_name": "é­”æ³•"}
        ]
      },
      "RequiredAbilities": {
        "type": "TArray<UGameplayAbility>",
        "display_name": "éœ€è¦çš„æŠ€èƒ½",
        "widget": "checkbox_list",
        "options_source": "gameplay_abilities"
      }
    }
  }
}
```

2. **åˆ›å»ºé…ç½®å­˜å‚¨æ–‡ä»¶** `configs/weapon_data.json`ï¼š

```json
{}
```

3. **æ·»åŠ æ‰«æè·¯å¾„** (å¯é€‰) åˆ° `scan_paths.json`ï¼š

```json
"weapon_data": {
  "description": "æ­¦å™¨æ•°æ®æ‰«æé…ç½®",
  "blueprint_paths": [
    "Content/Weapons/Data"
  ],
  "prefixes": ["WD_", "Weapon_"]
}
```

4. **é‡å¯å·¥å…·**ï¼Œæ–°çš„èµ„äº§ç±»å‹ä¼šè‡ªåŠ¨å‡ºç°åœ¨å¯¼èˆªæ 

### åŸç†
- `SchemaLoader` è‡ªåŠ¨åŠ è½½ `schema/` ç›®å½•ä¸‹çš„æ‰€æœ‰ JSON
- UI æ ¹æ® Schema åŠ¨æ€ç”Ÿæˆç¼–è¾‘å™¨
- æ•°æ®ä¿å­˜åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶

---

## â­â­ åœºæ™¯3ï¼šæ·»åŠ å¤æ‚å±æ€§ï¼ˆæ•°ç»„åµŒå¥—ç»“æ„ä½“ï¼‰

### éœ€æ±‚
æ­¦å™¨æœ‰å¤šä¸ª"ä¼¤å®³é˜¶æ®µ"ï¼Œæ¯ä¸ªé˜¶æ®µæœ‰ä¸åŒçš„ä¼¤å®³å’ŒæŒç»­æ—¶é—´ã€‚

### æ­¥éª¤

1. **åœ¨ `_common.json` ä¸­å®šä¹‰ç»“æ„ä½“**ï¼š

```json
{
  "structs": {
    "FWeaponDamagePhase": {
      "display_name": "ä¼¤å®³é˜¶æ®µ",
      "properties": {
        "PhaseName": {
          "type": "FString",
          "display_name": "é˜¶æ®µåç§°",
          "widget": "text_input"
        },
        "Damage": {
          "type": "float",
          "display_name": "ä¼¤å®³å€¼",
          "widget": "spinbox",
          "min": 0,
          "max": 500
        },
        "Duration": {
          "type": "float",
          "display_name": "æŒç»­æ—¶é—´(ç§’)",
          "widget": "spinbox",
          "min": 0,
          "max": 10
        },
        "DamageType": {
          "type": "EDamageType",
          "display_name": "ä¼¤å®³ç±»å‹",
          "widget": "combobox",
          "options": [
            {"name": "Physical", "display_name": "ç‰©ç†"},
            {"name": "Fire", "display_name": "ç«ç„°"},
            {"name": "Ice", "display_name": "å†°éœœ"}
          ]
        }
      }
    }
  }
}
```

2. **åœ¨ weapon_data.json ä¸­ä½¿ç”¨**ï¼š

```json
{
  "WeaponData": {
    "properties": {
      "DamagePhases": {
        "type": "TArray<FWeaponDamagePhase>",
        "display_name": "ä¼¤å®³é˜¶æ®µåˆ—è¡¨",
        "widget": "struct_array_editor",
        "struct_type": "FWeaponDamagePhase",
        "description": "æ­¦å™¨çš„å¤šæ®µä¼¤å®³é…ç½®"
      }
    }
  }
}
```

---

## â­â­â­ åœºæ™¯4ï¼šæ·»åŠ æ–°çš„æ§ä»¶ç±»å‹

### éœ€æ±‚
ä½ éœ€è¦ä¸€ä¸ªé¢œè‰²é€‰æ‹©å™¨æ§ä»¶ã€‚

### æ­¥éª¤

1. **åˆ›å»ºæ§ä»¶ç±»** `ui/widgets/color_picker.py`ï¼š

```python
import tkinter as tk
from tkinter import colorchooser
from ui.widgets.base import PropertyWidget

class ColorPickerWidget(PropertyWidget):
    """é¢œè‰²é€‰æ‹©å™¨æ§ä»¶"""
    
    def __init__(self, parent, prop, on_change=None):
        super().__init__(parent, prop, on_change)
        self._create_widget()
    
    def _create_widget(self):
        self.frame = tk.Frame(self.parent)
        self.frame.pack(fill=tk.X, pady=2)
        
        # æ ‡ç­¾
        tk.Label(self.frame, text=self.prop.display_name).pack(side=tk.LEFT)
        
        # é¢œè‰²é¢„è§ˆ
        self.color_label = tk.Label(self.frame, width=5, relief="solid")
        self.color_label.pack(side=tk.LEFT, padx=5)
        
        # é€‰æ‹©æŒ‰é’®
        tk.Button(self.frame, text="é€‰æ‹©é¢œè‰²", 
                  command=self._pick_color).pack(side=tk.LEFT)
        
        self._color = "#FFFFFF"
        self._update_preview()
    
    def _pick_color(self):
        color = colorchooser.askcolor(color=self._color)
        if color[1]:
            self._color = color[1]
            self._update_preview()
            self._notify_change()
    
    def _update_preview(self):
        self.color_label.config(bg=self._color)
    
    def get_value(self):
        return self._color
    
    def set_value(self, value):
        if value:
            self._color = value
            self._update_preview()
```

2. **åœ¨å·¥å‚ä¸­æ³¨å†Œ** `ui/widgets/factory.py`ï¼š

```python
from ui.widgets.color_picker import ColorPickerWidget

class WidgetFactory:
    def create(self, parent, prop, on_change=None):
        widget_type = prop.widget
        
        # ... ç°æœ‰ä»£ç  ...
        
        elif widget_type == "color_picker":  # â† æ·»åŠ è¿™ä¸ª
            return ColorPickerWidget(parent, prop, on_change)
```

3. **åœ¨ Schema ä¸­ä½¿ç”¨**ï¼š

```json
{
  "WeaponGlowColor": {
    "type": "FLinearColor",
    "display_name": "æ­¦å™¨å‘å…‰é¢œè‰²",
    "widget": "color_picker"
  }
}
```

---

## â­â­â­ åœºæ™¯5ï¼šä¿®æ”¹ UE èµ„äº§ç”Ÿæˆé€»è¾‘

### éœ€æ±‚
ä¸º WeaponData åˆ›å»º UE èµ„äº§æ—¶éœ€è¦é¢å¤–å¤„ç†ã€‚

### æ­¥éª¤

1. **åˆ›å»ºç”Ÿæˆè„šæœ¬** `ue_scripts/generate_weapon.py`ï¼š

```python
import unreal
import json
import os

def create_weapon_data(name, config):
    """åˆ›å»ºæ­¦å™¨æ•°æ®èµ„äº§"""
    
    package_path = "/Game/Weapons/Data"
    full_path = f"{package_path}/{name}"
    
    # æ£€æŸ¥/åˆ›å»ºèµ„äº§
    if unreal.EditorAssetLibrary.does_asset_exist(full_path):
        asset = unreal.EditorAssetLibrary.load_asset(full_path)
    else:
        asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
        factory = unreal.DataAssetFactory()
        factory.set_editor_property("data_asset_class", unreal.MyWeaponData)
        
        asset = asset_tools.create_asset(
            asset_name=name,
            package_path=package_path,
            asset_class=unreal.MyWeaponData,
            factory=factory
        )
    
    # è®¾ç½®å±æ€§
    if "WeaponName" in config:
        asset.set_editor_property("weapon_name", config["WeaponName"])
    
    if "Damage" in config:
        asset.set_editor_property("damage", float(config["Damage"]))
    
    # å¤„ç†ä¼¤å®³é˜¶æ®µæ•°ç»„
    if "DamagePhases" in config:
        phases = asset.get_editor_property("damage_phases")
        phases.clear()
        
        for phase_data in config["DamagePhases"]:
            phase = unreal.WeaponDamagePhase()  # ä½ çš„ç»“æ„ä½“ç±»å‹
            phase.set_editor_property("phase_name", phase_data.get("PhaseName", ""))
            phase.set_editor_property("damage", phase_data.get("Damage", 0))
            phase.set_editor_property("duration", phase_data.get("Duration", 0))
            phases.append(phase)
        
        asset.set_editor_property("damage_phases", phases)
    
    # ä¿å­˜
    unreal.EditorAssetLibrary.save_asset(full_path)
    unreal.log(f"æ­¦å™¨æ•°æ®åˆ›å»ºæˆåŠŸ: {full_path}")
    
    return asset

# ä¸»å…¥å£
if __name__ == "__main__":
    script_dir = os.path.dirname(__file__)
    config_file = os.path.join(script_dir, "..", "configs", "weapon_data.json")
    
    with open(config_file, 'r', encoding='utf-8') as f:
        all_configs = json.load(f)
    
    for name, config in all_configs.items():
        create_weapon_data(name, config)
```

2. **åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ ç”ŸæˆæŒ‰é’®**ï¼ˆéœ€è¦ä¿®æ”¹ `ui/editors/` ä¸­çš„ä»£ç ï¼‰

---

## ğŸ“ æ‰©å±•æ£€æŸ¥æ¸…å•

æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] Schema å®šä¹‰æ­£ç¡® (`configs/schema/*.json`)
- [ ] å…±äº«ç»“æ„ä½“å®šä¹‰å®Œæ•´ (`_common.json`)
- [ ] æ‰«æè·¯å¾„å·²é…ç½® (`scan_paths.json`)
- [ ] é…ç½®å­˜å‚¨æ–‡ä»¶å·²åˆ›å»º (`configs/*.json`)
- [ ] UE ç”Ÿæˆè„šæœ¬å·²ç¼–å†™ (`ue_scripts/*.py`)
- [ ] å·¥å‚å·²æ³¨å†Œæ–°æ§ä»¶ (å¦‚æœæ·»åŠ äº†æ–°æ§ä»¶)

---

## ğŸ’¡ è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹æ‰«æç»“æœ**
   ```
   æ£€æŸ¥ configs/options/selectable_options.json
   ```

2. **æŸ¥çœ‹ UE æ—¥å¿—**
   ```
   Window â†’ Developer Tools â†’ Output Log
   æœç´¢ "LogPython"
   ```

3. **æµ‹è¯• Schema åŠ è½½**
   ```python
   from core.schema_loader import SchemaLoader
   loader = SchemaLoader("path/to/configs")
   print(loader.get_all_asset_types())
   ```