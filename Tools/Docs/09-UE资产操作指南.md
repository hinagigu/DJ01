# 09 - UE èµ„äº§æ“ä½œæŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•é€šè¿‡ Python è„šæœ¬åœ¨ UE ç¼–è¾‘å™¨ä¸­åˆ›å»ºã€ä¿®æ”¹ã€ä¿å­˜å„ç±»èµ„äº§ã€‚

---

## ğŸ“ èµ„äº§æ“ä½œæµç¨‹

```mermaid
graph LR
    A[æ£€æŸ¥èµ„äº§æ˜¯å¦å­˜åœ¨] --> B{å­˜åœ¨?}
    B -->|æ˜¯| C[åŠ è½½ç°æœ‰èµ„äº§]
    B -->|å¦| D[åˆ›å»ºæ–°èµ„äº§]
    C --> E[è·å– CDO]
    D --> E
    E --> F[è®¾ç½®å±æ€§]
    F --> G[ä¿å­˜èµ„äº§]
```

---

## ğŸ”‘ åˆ›å»ºä¸åŒç±»å‹çš„èµ„äº§

### 1. åˆ›å»º DataAsset è“å›¾

```python
import unreal

def create_data_asset_blueprint(name, package_path, parent_class):
    """
    åˆ›å»ºç»§æ‰¿è‡ª DataAsset çš„è“å›¾
    
    Args:
        name: èµ„äº§åç§°ï¼Œå¦‚ "BP_MyExperience"
        package_path: ä¿å­˜è·¯å¾„ï¼Œå¦‚ "/Game/Experiences"
        parent_class: çˆ¶ç±»ï¼Œå¦‚ unreal.DJ01ExperienceDefinition
    """
    full_path = f"{package_path}/{name}"
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if unreal.EditorAssetLibrary.does_asset_exist(full_path):
        return unreal.EditorAssetLibrary.load_asset(full_path)
    
    # åˆ›å»ºè“å›¾
    asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
    factory = unreal.BlueprintFactory()
    factory.set_editor_property("parent_class", parent_class)
    
    blueprint = asset_tools.create_asset(
        asset_name=name,
        package_path=package_path,
        asset_class=unreal.Blueprint,
        factory=factory
    )
    
    return blueprint
```

### 2. åˆ›å»ºçº¯ DataAsset (éè“å›¾)

```python
def create_data_asset(name, package_path, asset_class):
    """
    åˆ›å»ºçº¯ DataAsset å®ä¾‹
    
    Args:
        name: èµ„äº§åç§°
        package_path: ä¿å­˜è·¯å¾„
        asset_class: èµ„äº§ç±»ï¼Œå¦‚ unreal.DJ01AbilitySet
    """
    full_path = f"{package_path}/{name}"
    
    if unreal.EditorAssetLibrary.does_asset_exist(full_path):
        return unreal.EditorAssetLibrary.load_asset(full_path)
    
    asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
    
    # ä½¿ç”¨ DataAsset å·¥å‚
    factory = unreal.DataAssetFactory()
    factory.set_editor_property("data_asset_class", asset_class)
    
    asset = asset_tools.create_asset(
        asset_name=name,
        package_path=package_path,
        asset_class=asset_class,
        factory=factory
    )
    
    return asset
```

### 3. åˆ›å»º InputMappingContext

```python
def create_input_mapping_context(name, package_path):
    """åˆ›å»ºå¢å¼ºè¾“å…¥æ˜ å°„ä¸Šä¸‹æ–‡"""
    full_path = f"{package_path}/{name}"
    
    if unreal.EditorAssetLibrary.does_asset_exist(full_path):
        return unreal.EditorAssetLibrary.load_asset(full_path)
    
    asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
    
    # è¾“å…¥æ˜ å°„ä¸Šä¸‹æ–‡æ²¡æœ‰ä¸“ç”¨å·¥å‚ï¼Œç›´æ¥åˆ›å»º
    asset = asset_tools.create_asset(
        asset_name=name,
        package_path=package_path,
        asset_class=unreal.InputMappingContext,
        factory=None
    )
    
    return asset
```

---

## ğŸ“ è®¾ç½®èµ„äº§å±æ€§

### 1. åŸºæœ¬å±æ€§

```python
def set_basic_properties(cdo, config):
    """è®¾ç½®åŸºæœ¬ç±»å‹å±æ€§"""
    
    # å­—ç¬¦ä¸²
    if "DisplayName" in config:
        cdo.set_editor_property("display_name", config["DisplayName"])
    
    # æ•°å€¼
    if "Priority" in config:
        cdo.set_editor_property("priority", int(config["Priority"]))
    
    # å¸ƒå°”å€¼
    if "IsEnabled" in config:
        cdo.set_editor_property("is_enabled", config["IsEnabled"])
    
    # æµ®ç‚¹æ•°
    if "Speed" in config:
        cdo.set_editor_property("speed", float(config["Speed"]))
```

### 2. èµ„äº§å¼•ç”¨

```python
def set_asset_reference(cdo, property_name, asset_path):
    """è®¾ç½®èµ„äº§å¼•ç”¨å±æ€§"""
    
    if not asset_path:
        return False
    
    # åŠ è½½å¼•ç”¨çš„èµ„äº§
    asset = unreal.EditorAssetLibrary.load_asset(asset_path)
    if asset is None:
        unreal.log_warning(f"æ— æ³•åŠ è½½èµ„äº§: {asset_path}")
        return False
    
    cdo.set_editor_property(property_name, asset)
    return True

# ä½¿ç”¨ç¤ºä¾‹
set_asset_reference(cdo, "default_pawn_data", "/Game/PawnData/PD_Hero")
```

### 3. è½¯å¼•ç”¨ (SoftObjectPtr)

```python
def set_soft_reference(cdo, property_name, asset_path):
    """è®¾ç½®è½¯å¼•ç”¨å±æ€§"""
    
    if not asset_path:
        return
    
    # åˆ›å»ºè½¯å¼•ç”¨è·¯å¾„
    soft_path = unreal.SoftObjectPath(asset_path)
    cdo.set_editor_property(property_name, soft_path)

# ä½¿ç”¨ç¤ºä¾‹
set_soft_reference(cdo, "ability_class", "/Game/Abilities/GA_Jump.GA_Jump_C")
```

### 4. æ•°ç»„å±æ€§

```python
def set_array_property(cdo, property_name, values, item_loader=None):
    """è®¾ç½®æ•°ç»„å±æ€§"""
    
    # è·å–å½“å‰æ•°ç»„ï¼ˆç¡®å®šç±»å‹ï¼‰
    current_array = cdo.get_editor_property(property_name)
    
    # æ¸…ç©ºç°æœ‰å†…å®¹
    current_array.clear()
    
    # æ·»åŠ æ–°å†…å®¹
    for value in values:
        if item_loader:
            item = item_loader(value)
            if item:
                current_array.append(item)
        else:
            current_array.append(value)
    
    cdo.set_editor_property(property_name, current_array)

# ä½¿ç”¨ç¤ºä¾‹ï¼šè®¾ç½®å­—ç¬¦ä¸²æ•°ç»„
set_array_property(cdo, "tags", ["Tag1", "Tag2", "Tag3"])

# ä½¿ç”¨ç¤ºä¾‹ï¼šè®¾ç½®èµ„äº§å¼•ç”¨æ•°ç»„
def load_ability(path):
    return unreal.EditorAssetLibrary.load_asset(path)

set_array_property(cdo, "abilities", 
    ["/Game/Abilities/GA_Jump", "/Game/Abilities/GA_Dash"],
    item_loader=load_ability
)
```

### 5. Gameplay Tags

```python
def set_gameplay_tags(cdo, property_name, tag_names):
    """è®¾ç½® GameplayTag æ•°ç»„"""
    
    tag_container = unreal.GameplayTagContainer()
    
    for tag_name in tag_names:
        tag = unreal.GameplayTag.request_gameplay_tag(tag_name)
        if tag.is_valid():
            tag_container.add_tag(tag)
        else:
            unreal.log_warning(f"æ— æ•ˆçš„æ ‡ç­¾: {tag_name}")
    
    cdo.set_editor_property(property_name, tag_container)

# ä½¿ç”¨ç¤ºä¾‹
set_gameplay_tags(cdo, "ability_tags", [
    "Ability.Active.Jump",
    "Ability.Active.Dash"
])
```

### 6. ç»“æ„ä½“å±æ€§

```python
def set_struct_property(cdo, property_name, struct_data):
    """è®¾ç½®ç»“æ„ä½“å±æ€§"""
    
    # è·å–å½“å‰ç»“æ„ä½“ï¼ˆç¡®å®šç±»å‹ï¼‰
    struct = cdo.get_editor_property(property_name)
    
    # è®¾ç½®ç»“æ„ä½“çš„å„ä¸ªå­—æ®µ
    for field_name, field_value in struct_data.items():
        struct.set_editor_property(field_name, field_value)
    
    cdo.set_editor_property(property_name, struct)
```

---

## ğŸ’¾ ä¿å­˜èµ„äº§

```python
def save_asset(asset_path, force_save=False):
    """ä¿å­˜èµ„äº§"""
    
    if not unreal.EditorAssetLibrary.does_asset_exist(asset_path):
        unreal.log_error(f"èµ„äº§ä¸å­˜åœ¨: {asset_path}")
        return False
    
    # ä¿å­˜å•ä¸ªèµ„äº§
    success = unreal.EditorAssetLibrary.save_asset(
        asset_path, 
        only_if_is_dirty=not force_save
    )
    
    if success:
        unreal.log(f"ä¿å­˜æˆåŠŸ: {asset_path}")
    else:
        unreal.log_error(f"ä¿å­˜å¤±è´¥: {asset_path}")
    
    return success

def save_all_dirty_assets():
    """ä¿å­˜æ‰€æœ‰å·²ä¿®æ”¹çš„èµ„äº§"""
    unreal.EditorAssetLibrary.save_loaded_assets()
```

---

## ğŸ”„ å®Œæ•´ç¤ºä¾‹ï¼šåˆ›å»º Experience

```python
import unreal
import json
import os

def create_experience(name: str, config: dict) -> bool:
    """
    åˆ›å»ºå®Œæ•´çš„ Experience èµ„äº§
    
    Args:
        name: Experience åç§°
        config: é…ç½®å­—å…¸ï¼ŒåŒ…å«æ‰€æœ‰å±æ€§
    
    Returns:
        bool: æ˜¯å¦æˆåŠŸ
    """
    package_path = "/Game/Experiences"
    full_path = f"{package_path}/{name}"
    
    try:
        # 1. åˆ›å»ºæˆ–åŠ è½½è“å›¾
        if unreal.EditorAssetLibrary.does_asset_exist(full_path):
            blueprint = unreal.EditorAssetLibrary.load_asset(full_path)
            unreal.log(f"åŠ è½½ç°æœ‰èµ„äº§: {full_path}")
        else:
            asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
            factory = unreal.BlueprintFactory()
            factory.set_editor_property("parent_class", unreal.DJ01ExperienceDefinition)
            
            blueprint = asset_tools.create_asset(
                asset_name=name,
                package_path=package_path,
                asset_class=unreal.Blueprint,
                factory=factory
            )
            unreal.log(f"åˆ›å»ºæ–°èµ„äº§: {full_path}")
        
        # 2. è·å– CDO
        generated_class = blueprint.get_editor_property("generated_class")
        if generated_class is None:
            # å°è¯•å…¶ä»–æ–¹å¼è·å–
            generated_class = getattr(blueprint, 'GeneratedClass', None)
        
        if generated_class is None:
            unreal.log_error("æ— æ³•è·å– GeneratedClass")
            return False
        
        cdo = unreal.get_default_object(generated_class)
        
        # 3. è®¾ç½® DefaultPawnData
        if "DefaultPawnData" in config:
            pawn_path = config["DefaultPawnData"]
            pawn_data = unreal.EditorAssetLibrary.load_asset(pawn_path)
            if pawn_data:
                cdo.set_editor_property("default_pawn_data", pawn_data)
            else:
                unreal.log_warning(f"æ— æ³•åŠ è½½ PawnData: {pawn_path}")
        
        # 4. è®¾ç½® GameFeatures
        if "GameFeaturesToEnable" in config:
            features = config["GameFeaturesToEnable"]
            feature_array = cdo.get_editor_property("game_features_to_enable")
            feature_array.clear()
            for feature in features:
                feature_array.append(feature)
            cdo.set_editor_property("game_features_to_enable", feature_array)
        
        # 5. ä¿å­˜
        unreal.EditorAssetLibrary.save_asset(full_path)
        unreal.log(f"Experience åˆ›å»ºæˆåŠŸ: {full_path}")
        
        return True
        
    except Exception as e:
        unreal.log_error(f"åˆ›å»ºå¤±è´¥: {e}")
        import traceback
        unreal.log_error(traceback.format_exc())
        return False


# ä¸»å…¥å£
if __name__ == "__main__":
    # ä»é…ç½®æ–‡ä»¶è¯»å–
    script_dir = os.path.dirname(__file__)
    config_file = os.path.join(script_dir, "..", "configs", "experiences.json")
    
    with open(config_file, 'r', encoding='utf-8') as f:
        all_configs = json.load(f)
    
    success_count = 0
    for exp_name, exp_config in all_configs.items():
        if create_experience(exp_name, exp_config):
            success_count += 1
    
    unreal.log(f"å®Œæˆ: {success_count}/{len(all_configs)} ä¸ª Experience åˆ›å»ºæˆåŠŸ")
```

---

## âš ï¸ å¸¸è§é”™è¯¯å¤„ç†

```python
def safe_create_asset(func):
    """è£…é¥°å™¨ï¼šå®‰å…¨åˆ›å»ºèµ„äº§"""
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as e:
            unreal.log_error(f"èµ„äº§æ“ä½œå¤±è´¥: {e}")
            import traceback
            unreal.log_error(traceback.format_exc())
            return None
    return wrapper

@safe_create_asset
def create_my_asset(...):
    ...
```