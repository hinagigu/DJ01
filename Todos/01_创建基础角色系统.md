# 创建基础角色系统攻略

## 步骤一：创建必要的输入动作（Input Actions）

1. 在内容浏览器中创建基础输入动作：
   - 右键 Content/Input > New Input > Input Action
   - 创建以下输入动作：
     * IA_Move (Type: 2D Vector)
     * IA_Look (Type: 2D Vector)
     * IA_Jump (Type: Button)

2. 配置每个输入动作的属性：
   - IA_Move: 
     * Value Type: Type: 2D Vector
     * Expected Controls: Left Stick/WASD
   - IA_Look:
     * Value Type: Type: 2D Vector
     * Expected Controls: Mouse X/Y, Right Stick
   - IA_Jump:
     * Value Type: Button
     * Expected Controls: Space Bar, Gamepad Face Button Bottom

## 步骤二：创建输入映射上下文（Input Mapping Context）

1. 在内容浏览器中创建：
   - 右键 Content/Input > New Input > Input Mapping Context
   - 命名为 "IMC_Default"

2. 配置映射：
   - Move:
     * 添加 WASD 键映射到 IA_Move
     * 添加左摇杆映射到 IA_Move
   - Look:
     * 添加鼠标 X/Y 轴映射到 IA_Look
     * 添加右摇杆映射到 IA_Look
   - Jump:
     * 添加空格键映射到 IA_Jump
     * 添加游戏手柄 Face Button Bottom 映射到 IA_Jump

## 步骤三：创建 InputConfig 数据资产

### InputConfig 的设计说明

InputConfig 是一个统一的输入配置系统，包含两种输入类型：

1. **NativeInputActions（原生输入动作）**
   - 用于：基础角色控制（移动、视角、跳跃等）
   - 绑定方式：通过 `BindNativeAction` 手动绑定到 C++ 函数
   - Tag 作用：作为**查找键**，在 InputConfig 中根据 Tag 查找对应的 InputAction
   - 示例：移动、视角、跳跃

2. **AbilityInputActions（技能输入动作）**
   - 用于：Gameplay Ability System (GAS) 技能
   - 绑定方式：自动绑定到 AbilitySystemComponent，通过 Tag 激活对应技能
   - Tag 作用：匹配并激活对应的 Gameplay Ability
   - 示例：攻击、闪避、使用道具、特殊技能

### 创建步骤

1. 在内容浏览器中：
   - 右键 Content/Input > Miscellaneous > Data Asset
   - 选择 **DJ01InputConfig** 类
   - 命名为 "InputConfig_Default"

2. 配置 InputConfig：
   - 在 **Native Input Actions** 中添加基础输入：
     * 点击 + 添加元素
     * Input Action: IA_Move，Input Tag: `InputTag.Move`
     * Input Action: IA_Look，Input Tag: `InputTag.Look`
     * Input Action: IA_Jump，Input Tag: `InputTag.Jump`
   
   - **Ability Input Actions** 暂时留空
     * 等引入 GAS 系统后再配置技能输入
     * 未来可添加：攻击、闪避、交互等技能相关输入

### 创建必要的 Gameplay Tags

在使用 InputConfig 之前，需要先创建对应的 Gameplay Tags：

1. 打开项目设置：Edit → Project Settings
2. 导航到：Project → Gameplay Tags
3. 确保 "Import Tags From Config" 已启用
4. 点击 "Manage Gameplay Tags"
5. 添加以下标签结构：
   ```
   InputTag
   ├── InputTag.Move
   ├── InputTag.Look
   └── InputTag.Jump
   ```

**注意：** Tag 的命名必须与 InputConfig 中配置的完全一致！

## 步骤四：创建 GameFeatureData

1. 在内容浏览器中：
   - 右键 Content/GameFeatures > New Asset > Game Feature Data
   - 命名为 "GFD_DefaultCharacter"

2. 配置 GameFeatureData：
   - 添加 "Add Input Context Mapping" action：
     * 设置 IMC_Default 为映射上下文
     * 设置优先级为 1
   
   - 添加 "Add Input Binding" action：
     * 设置 InputConfig_Default 为配置
     * 设置目标组件类为 DJ01HeroComponent
   
   - 添加 "Add Components" action：
     * 添加 DJ01HeroComponent 到 DJ01Character
     * 添加 DJ01CameraComponent 到 DJ01Character

## 步骤五：创建角色蓝图

1. 创建角色蓝图：
   - 右键 Content/Characters > New Blueprint > Character
   - 选择父类为 DJ01Character
   - 命名为 "BP_PlayerCharacter"

2. 配置角色蓝图：
   - 添加 Character Movement Component（如果没有）
   - 配置基本移动参数：
     * Walk Speed: 600
     * Jump Z Velocity: 500
     * Air Control: 0.5
   - 设置胶囊体组件大小：
     * Radius: 40
     * Half Height: 90

## 步骤六：设置游戏模式

1. 创建游戏模式蓝图：
   - 右键 Content/GameModes > New Blueprint > Game Mode Base
   - 命名为 "BP_GameMode"

2. 配置游戏模式：
   - 设置 Default Pawn Class 为 BP_PlayerCharacter

## 步骤七：测试设置

1. 在项目设置中：
   - 设置 Default GameMode 为 BP_GameMode
   - 确保 Game Feature Plugins 中启用了相关功能

2. 在编辑器中测试：
   - 点击 Play 按钮
   - 测试基本移动（WASD）
   - 测试视角控制（鼠标）
   - 测试跳跃（空格键）

## 技术细节说明

### InputConfig 工作流程

```
GameFeatureData (GFD_DefaultCharacter)
  └─> GameFeatureAction_AddInputBinding
       └─> 引用 InputConfig_Default
            └─> DJ01HeroComponent::AddAdditionalInputConfig
                 └─> BindInputConfig
                      └─> DJ01InputComponent::BindNativeAction
                           └─> 根据 InputTag 查找 InputAction
                                └─> 绑定到具体的 C++ 函数
                                     ├─> Input_Move
                                     ├─> Input_Look
                                     └─> Input_Jump
```

### 为什么基础输入也要用 InputConfig？

虽然可以直接在代码中硬编码绑定，但使用 InputConfig 有以下优势：

1. **统一管理**：所有输入配置集中在一个数据资产中
2. **模块化设计**：可通过 GameFeature 动态添加/移除输入
3. **灵活配置**：不同游戏模式可使用不同的 InputConfig
4. **架构一致性**：基础输入和技能输入使用同一套系统
5. **易于扩展**：未来可以轻松将基础动作改造成技能（如二段跳）

### Tag 的两种用途

1. **对于 NativeInputActions**：
   - Tag 是查找键，用于在 InputConfig 中定位 InputAction
   - 与 GAS 无关，纯粹是配置查找机制

2. **对于 AbilityInputActions**：
   - Tag 用于匹配和激活 Gameplay Ability
   - 必须与技能上配置的 InputTag 一致

## 注意事项

1. **必须先创建 Gameplay Tags**，否则无法配置 InputConfig
2. **Tag 命名必须精确匹配**，包括大小写和层级
3. 确保所有资产路径正确
4. 检查 GameFeatureData 是否正确加载
5. 确保输入系统正确配置
6. 如果输入没有响应，检查：
   - Gameplay Tags 是否已创建
   - Input Action 配置是否正确
   - Input Mapping Context 设置是否正确
   - GameFeatureData 加载状态
   - DJ01HeroComponent 是否正确添加到角色
   - InputComponent 是否是 UDJ01InputComponent 类型

## 代码实现检查清单

在继续之前，确保以下代码已实现：

### DJ01HeroComponent.h
- [ ] 添加了 `BindInputConfig` 私有函数声明
- [ ] 添加了 `Input_Move`、`Input_Look`、`Input_Jump` 函数声明

### DJ01HeroComponent.cpp
- [ ] 包含了 `DJ01InputComponent.h` 头文件
- [ ] `AddAdditionalInputConfig` 中调用了 `BindInputConfig`
- [ ] 实现了 `BindInputConfig` 函数
- [ ] 实现了 `Input_Move`、`Input_Look`、`Input_Jump` 函数

### DJ01Character.cpp（可选但推荐）
- [ ] 覆盖了 `CreatePlayerInputComponent` 函数，返回 `UDJ01InputComponent`

## 下一步

### 阶段一：完善基础系统
1. ✅ 配置基础输入系统（当前步骤）
2. ⬜ 配置角色动画蓝图
3. ⬜ 完善相机控制系统
4. ⬜ 测试基础移动和视角控制

### 阶段二：引入 GAS 系统
1. ⬜ 添加 AbilitySystemComponent
2. ⬜ 创建基础 Gameplay Abilities（跳跃技能化）
3. ⬜ 在 InputConfig 中配置 AbilityInputActions
4. ⬜ 实现技能激活逻辑

### 阶段三：扩展游戏功能
1. ⬜ 添加更多输入动作（冲刺、蹲伏、交互等）
2. ⬜ 实现 Gameplay Effects（速度提升、伤害等）
3. ⬜ 添加 UI 系统
4. ⬜ 实现更多游戏特性

## 参考资料

- **Lyra 输入系统文档**：官方文档详细说明了输入系统的设计理念
- **UDJ01InputComponent 源码**：查看 `BindNativeAction` 和 `BindAbilityActions` 的实现
- **GameFeatureAction_AddInputBinding 源码**：理解输入绑定的生命周期管理
- **项目中的示例代码**：参考已实现的相机控制输入

## 常见问题解决

### 1. 输入没有响应

**检查清单：**
- [ ] Gameplay Tags 是否已创建（InputTag.Move、InputTag.Look、InputTag.Jump）
- [ ] InputConfig_Default 是否正确配置
- [ ] GameFeatureData 是否正确加载并激活
- [ ] Input Mapping Context (IMC_Default) 是否添加
- [ ] DJ01HeroComponent 是否添加到角色
- [ ] 项目设置中是否启用了 Enhanced Input 系统
- [ ] PlayerController 的 InputComponent 是否是 UDJ01InputComponent 类型

**调试方法：**
```cpp
// 在 DJ01HeroComponent::BindInputConfig 中添加日志
UE_LOG(LogTemp, Warning, TEXT("绑定输入配置: %s"), *GetNameSafe(InputConfig));

// 在输入回调中添加日志
void UDJ01HeroComponent::Input_Move(const FInputActionValue& InputActionValue)
{
    UE_LOG(LogTemp, Warning, TEXT("Input_Move 被调用: %s"), *InputActionValue.Get<FVector2D>().ToString());
    // ...
}
```

### 2. 找不到 InputTag

**错误信息：** "Requested Gameplay Tag InputTag.Move was not found"

**解决方法：**
1. 打开 Project Settings → Gameplay Tags
2. 确认 "Import Tags From Config" 已启用
3. 点击 "Manage Gameplay Tags" → "Add New Tag"
4. 手动添加 InputTag 及其子标签
5. 重启编辑器

### 3. 角色不移动

**检查清单：**
- [ ] Character Movement Component 是否正确配置
- [ ] 输入绑定是否成功（查看日志）
- [ ] 碰撞设置是否正确
- [ ] 角色是否有 Mesh 或 Collision

**验证方法：**
- 在 Input_Move 中打印日志，确认函数被调用
- 检查 MoveValue 是否为 0
- 在编辑器中查看角色的 Movement Component 设置

### 4. InputComponent 类型不匹配

**错误信息：** "InputComponent 不是 UDJ01InputComponent 类型"

**原因：** 默认创建的 InputComponent 不是 DJ01InputComponent

**解决方法：**
在角色的 `.cpp` 文件中覆盖 `CreatePlayerInputComponent`：

```cpp
// 在 DJ01Character.cpp 中
UInputComponent* ADJ01Character::CreatePlayerInputComponent()
{
    return NewObject<UDJ01InputComponent>(this, UDJ01InputComponent::StaticClass());
}
```

### 5. 相机问题

**检查清单：**
- [ ] DJ01CameraComponent 是否添加到角色
- [ ] 相机模式是否正确设置
- [ ] Input_Look 函数是否被调用
- [ ] Camera Manager 是否正确配置

### 6. GameFeatureData 未加载

**检查清单：**
- [ ] GameFeatureData 资产是否存在
- [ ] 在项目设置中是否启用了 Game Features 插件
- [ ] GameFeatureData 的 Initial State 是否设置为 Active
- [ ] 检查 Output Log 中的 GameFeature 相关日志